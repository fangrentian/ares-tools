"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const s=require("express"),E=require("express-ws"),config_Result=require("../config/Result.cjs"),utils_logger=require("../utils/logger.cjs"),utils_index=require("../utils/index.cjs");function _interopDefaultCompat(u){return u&&typeof u=="object"&&"default"in u?u.default:u}const s__default=_interopDefaultCompat(s),E__default=_interopDefaultCompat(E),sendWsEvent=(u,o,e)=>{try{o&&o.send(JSON.stringify(config_Result.Result.success(e)))}catch(n){utils_logger.logger.error(`\u63A8\u9001 WEBSOCKET \u6D88\u606F\u5230 ${u} \u5931\u8D25`,n)}},i=s__default.Router();E__default(i);let t;i.ws("/connect",function(u,o){t||(t=new utils_index.AppMapUtil(o.app));const e=o.sessionID;t.addWsClient(e,u),utils_logger.logger.log(`WEBSOCKET \u5BA2\u6237\u7AEF\u5DF2\u8FDE\u63A5\uFF0CsessionID: ${e}\uFF0C\u5F53\u524D WEBSOCKET \u5BA2\u6237\u7AEF\u603B\u6570: ${t.getWsClientCount()}`),sendWsEvent(e,u,`HELLO WEBSOCKET, sessionID: ${e}`),u.on("close",function(){utils_logger.logger.log("WEBSOCKET\u5173\u95ED\uFF0CsessionID:",e),t.removeWsClient(e),utils_logger.logger.log(`WEBSOCKET \u5BA2\u6237\u7AEF\u5DF2\u65AD\u5F00\uFF0CsessionID: ${e}\uFF0C\u5F53\u524D WEBSOCKET \u5BA2\u6237\u7AEF\u603B\u6570: ${t.getWsClientCount()}`)}),u.on("error",function(n){utils_logger.logger.error("WEBSOCKET\u53D1\u751F\u5F02\u5E38",n.stack)}),u.on("message",function(n){utils_logger.logger.log("WEBSOCKET\u6536\u5230\u6D88\u606F",n),sendWsEvent(e,u,`\u5DF2\u63A5\u6536\u5230\u4F60\u7684\u6D88\u606F, sessionID: ${e}`)})}),exports.default=i,exports.sendWsEvent=sendWsEvent;
