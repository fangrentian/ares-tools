import F from"express";import{Result as n}from"../config/Result.mjs";import{AppMapUtil as a}from"../utils/index.mjs";import{sendWsEvent as d}from"./ws.mjs";import{sendSseEvent as i}from"./sse.mjs";const c=F.Router();let t;c.post("/sse",(s,o)=>{t||(t=new a(s.app));const u=s.body.sessionId,D=s.body.data,e=t.getSseClient(u);if(e)try{i(u,e,D),o.send(n.success(`\u53D1\u9001 SSE \u6D88\u606F\u5230 ${u} \u6210\u529F`))}catch(r){console.error(`\u53D1\u9001 SSE \u6D88\u606F\u5230 ${u} \u5931\u8D25:`,r),o.status(500).send(n.fail(`\u53D1\u9001 SSE \u6D88\u606F\u5230 ${u} \u5931\u8D25`))}else o.status(500).send(n.fail("SSE \u5BA2\u6237\u7AEF\u4E0D\u5B58\u5728"))}),c.post("/sse-broadcast",(s,o)=>{t||(t=new a(s.app));const u=t.getSseClients(),D=[];for(const[e,r]of u)try{i(e,r,s.body.data)}catch(E){console.error(`\u53D1\u9001 SSE \u6D88\u606F\u5230 ${e} \u5931\u8D25:`,E),D.push(e)}D.length>0?o.send(n.fail(D,"\u5E7F\u64AD SSE \u6D88\u606F\u5931\u8D25\u7684\u4F1A\u8BDDID\u5217\u8868")):o.send(n.success("\u5E7F\u64AD SSE \u6D88\u606F\u6210\u529F"))}),c.post("/ws",(s,o)=>{t||(t=new a(s.app));const u=s.body.sessionId,D=s.body.data,e=t.getWsClient(u);if(e)try{d(u,e,D),o.send(n.success(`\u53D1\u9001 WEBSOCKET \u6D88\u606F\u5230 ${u} \u6210\u529F`))}catch(r){console.error(`\u53D1\u9001 WEBSOCKET \u6D88\u606F\u5230 ${u} \u5931\u8D25:`,r),o.send(n.fail(`\u53D1\u9001 WEBSOCKET \u6D88\u606F\u5230 ${u} \u5931\u8D25`))}else o.send(n.fail("WEBSOCKET \u5BA2\u6237\u7AEF\u4E0D\u5B58\u5728"))}),c.post("/ws-broadcast",(s,o)=>{t||(t=new a(s.app));const u=t.getWsClients(),D=[];for(const[e,r]of u)try{d(e,r,s.body.data)}catch(E){console.error(`\u53D1\u9001 WEBSOCKET \u6D88\u606F\u5230 ${e} \u5931\u8D25:`,E),D.push(e)}D.length>0?o.send(n.fail(D,"\u5E7F\u64AD WEBSOCKET \u6D88\u606F\u5931\u8D25\u7684\u4F1A\u8BDDID\u5217\u8868")):o.send(n.success("\u5E7F\u64AD WEBSOCKET \u6D88\u606F\u6210\u529F"))});export{c as default};
