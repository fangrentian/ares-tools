import r from"express";import i from"express-ws";import{Result as C}from"../config/Result.mjs";import{logger as s}from"../utils/logger.mjs";import{AppMapUtil as D}from"../utils/index.mjs";const E=(o,e,u)=>{try{e&&e.send(JSON.stringify(C.success(u)))}catch(n){s.error(`\u63A8\u9001 WEBSOCKET \u6D88\u606F\u5230 ${o} \u5931\u8D25`,n)}},F=r.Router();i(F);let t;F.ws("/connect",function(o,e){t||(t=new D(e.app));const u=e.sessionID;t.addWsClient(u,o),s.log(`WEBSOCKET \u5BA2\u6237\u7AEF\u5DF2\u8FDE\u63A5\uFF0CsessionID: ${u}\uFF0C\u5F53\u524D WEBSOCKET \u5BA2\u6237\u7AEF\u603B\u6570: ${t.getWsClientCount()}`),E(u,o,`HELLO WEBSOCKET, sessionID: ${u}`),o.on("close",function(){s.log("WEBSOCKET\u5173\u95ED\uFF0CsessionID:",u),t.removeWsClient(u),s.log(`WEBSOCKET \u5BA2\u6237\u7AEF\u5DF2\u65AD\u5F00\uFF0CsessionID: ${u}\uFF0C\u5F53\u524D WEBSOCKET \u5BA2\u6237\u7AEF\u603B\u6570: ${t.getWsClientCount()}`)}),o.on("error",function(n){s.error("WEBSOCKET\u53D1\u751F\u5F02\u5E38",n.stack)}),o.on("message",function(n){s.log("WEBSOCKET\u6536\u5230\u6D88\u606F",n),E(u,o,`\u5DF2\u63A5\u6536\u5230\u4F60\u7684\u6D88\u606F, sessionID: ${u}`)})});export{F as default,E as sendWsEvent};
