import H from"fs";import m from"dayjs";import{logger as t}from"./logger.mjs";import{getBuildConfig as S,getBastionConfig as B,getBastionTargetConfig as s,getBastionChannelConfig as C,buildProject as g}from"./common.mjs";import{getBastionSSHClient as A,getDirectoryFromIntraServer as T,makeDirectoryOnIntraServer as D,execIntraServerCommand as F,putDirectoryToIntraServer as b}from"./ssh.mjs";import{execCommandUnderDirectory as k}from"./childProcess.mjs";async function v(i,u,E){const{localDownloadDir:r,remoteDir:e}=u;t.info("\u5F00\u59CB\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5230\u672C\u5730...");const o=m().format("YYYY-MM-DD_HHmmss");await k(r,`mkdir ${o}`);const a=await T(i,E,u,{localDir:`${r}${o}`,remoteDir:e});return t.info("\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5230\u672C\u5730\u5B8C\u6210"),a}async function f(i,u,E){const{remoteBackupDir:r,remoteDir:e}=u;t.info("\u5F00\u59CB\u5728\u670D\u52A1\u5668\u7AEF\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE...");const o=m().format("YYYY-MM-DD_HHmmss"),a=`${r}${o}`;await D(i,E,u,{path:a});const n=await F(i,E,u,`cp -ra ${e}. ${a}`);return t.info("\u5728\u670D\u52A1\u5668\u7AEF\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5B8C\u6210"),n}async function l(i,u,E){const{remoteDir:r,remoteDirTemp:e,remoteBackupDir:o}=u;if(t.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55..."),(await F(i,E,u,`test -d ${r}`)).code!==0)try{t.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u76EE\u6807\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u76EE\u6807\u76EE\u5F55..."),await D(i,E,u,{path:r}),t.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u6807\u76EE\u5F55\u6210\u529F")}catch(n){throw n}t.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const a=await F(i,E,u,`test -d ${e}`);if(a.code!==0)try{t.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u4E34\u65F6\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55..."),await D(i,E,u,{path:e}),t.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55\u6210\u529F")}catch(n){throw n}if(t.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u5907\u4EFD\u76EE\u5F55..."),await F(i,E,u,`test -d ${o}`),a.code!==0)try{t.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u5907\u4EFD\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u5907\u4EFD\u76EE\u5F55..."),await D(i,E,u,{path:o}),t.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u5907\u4EFD\u76EE\u5F55\u6210\u529F")}catch(n){throw n}}async function p(i,u,E){const{remoteHealthFile:r,remoteHideHealthFileDir:e}=u;t.info("\u5F00\u59CB\u9690\u85CF\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6...");const o=await F(i,E,u,`mv ${r} ${e}`);return t.info("\u9690\u85CF\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6\u5B8C\u6210"),o}async function w(i,u,E){const{remoteHealthHiddenFile:r,remoteHealthDir:e}=u;t.info("\u5F00\u59CB\u8FD8\u539F\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6...");const o=await F(i,E,u,`mv ${r} ${e}`);return t.info("\u8FD8\u539F\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6\u5B8C\u6210"),o}async function y(i,u,E){const{remoteDirTemp:r}=u;t.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const e=await F(i,E,u,`rm -rf ${r}*`);return t.info("\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210"),e}async function h(i,u,E){const{localDeployDir:r,remoteDirTemp:e}=u;t.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const o=await b(i,E,u,{localDir:r,remoteDir:e});return t.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210"),o}async function d(i,u,E){const{remoteDir:r}=u;t.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55...");const e=await F(i,E,u,`rm -rf ${r}*`);return t.info("\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210"),e}async function $(i,u,E){const{remoteDir:r,remoteDirTemp:e}=u;t.info("\u5F00\u59CB\u79FB\u52A8\u4E34\u65F6\u76EE\u5F55\u6587\u4EF6\u5230\u76EE\u6807\u76EE\u5F55...");const o=await F(i,E,u,`mv ${e}* ${r}`);return t.info("\u6587\u4EF6\u79FB\u52A8\u5B8C\u6210"),o}async function x(i={},u={},E={}){let r;const e=S(i),o=B(u),a=s(E),n=C(a);try{const{localDeployDir:c}=a;if(!H.existsSync(c))throw new Error(`\u672C\u5730\u76EE\u5F55 ${c} \u4E0D\u5B58\u5728`);return e.build&&await g(e),r=await A(o),await l(r,a,n),await f(r,a,n),await y(r,a,n),await h(r,a,n),await d(r,a,n),await $(r,a,n),t.info("\u90E8\u7F72\u5B8C\u6210!"),!0}catch(c){return t.error("\u90E8\u7F72\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF:",c),!1}finally{t.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),r?.dispose()}}async function Y(i={},u={}){let E;const r=B(i),e=s(u),o=C(e);try{E=await A(r),await w(E,e,o),t.info("\u5F00\u542F\u5065\u5EB7\u68C0\u67E5\u6210\u529F!")}catch(a){t.error("\u5F00\u542F\u5065\u5EB7\u68C0\u67E5\u65F6\u51FA\u73B0\u9519\u8BEF:",a)}finally{t.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),E?.dispose()}}async function R(i={},u={}){let E;const r=B(i),e=s(u),o=C(e);try{E=await A(r),await p(E,e,o),t.info("\u5173\u95ED\u5065\u5EB7\u68C0\u67E5\u6210\u529F!")}catch(a){t.error("\u5173\u95ED\u5065\u5EB7\u68C0\u67E5\u65F6\u51FA\u73B0\u9519\u8BEF:",a)}finally{t.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),E?.dispose()}}process.on("uncaughtException",i=>{t.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u6355\u83B7\u7684\u5F02\u5E38: ${i}`)}),process.on("unhandledRejection",(i,u)=>{t.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u5904\u7406\u7684\u62D2\u7EDD: ${u} \u539F\u56E0\u662F: ${i}`)});export{v as backupLocal,f as backupRemote,l as checkRemoteDirExist,d as clearRemoteTargetDir,y as clearRemoteTempDir,x as deployToLinuxBastionInternalServer,R as disableLinuxBastionHealthCheck,w as displayHealthFile,Y as enableLinuxBastionHealthCheck,p as hideHealthFile,$ as moveRemoteTempDirToTargetDir,h as uploadToRemoteTempDir};
