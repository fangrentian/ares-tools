import w from"fs";import s from"dayjs";import{getDirectoryFromIntraServer as y,makeDirectoryOnIntraServer as a,execIntraServerCommand as i,getBastionSSHClient as n,putDirectoryToIntraServer as d}from"./ssh.mjs";import{execCommandUnderDirectory as I,execProjectPNPMCommand as $}from"./childProcess.mjs";import{logger as o}from"./logger.mjs";const{BUILD_MODE:B,PROJECT_DIR:h,LOCAL_DEPLOY_DIR:O,LOCAL_DOWNLOAD_DIR:L,BASTION_SSH_HOST:g,BASTION_SSH_USER:P,BASTION_SSH_PASSWORD:G,BASTION_SSH_PORT:v,BASTION_SSH_PRIVATE_KEY:b,TARGET_SSH_HOST:x,TARGET_SSH_USER:Y,TARGET_SSH_PASSWORD:N,TARGET_SSH_PORT:k,TARGET_SSH_PRIVATE_KEY:M,TARGET_BK_DIR:K,TARGET_DIR:F,TARGET_FOLDER_TEMP:C,TARGET_FOLDER_TARGET:T,TARGET_HEALTH_DIR:U,TARGET_HIDE_HEALTH_FILE_DIR:j,TARGET_HEALTH_FILE:W,TARGET_HEALTH_HIDDEN_FILE:V}=process.env,D={host:g,port:v,username:P,password:G,privateKey:b},t={host:x,port:k,username:Y,password:N,privateKey:M,localDeployDir:O,localDownloadDir:L,remoteDirTemp:`${F}${C}`,remoteDirTarget:`${F}${T}`},r={dstIP:t.host,dstPort:t.port};async function l(){const E=B?`build:${B}`:"build";o.info("----->\u5F00\u59CB\u6253\u5305\u9879\u76EE...");const u=await $(h,E);return o.info("----->\u6253\u5305\u9879\u76EE\u5B8C\u6210"),u}async function J(E){o.info("----->\u5F00\u59CB\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5230\u672C\u5730...");const u=s().format("YYYY-MM-DD_HHmmss");await I(t.localDownloadDir,`mkdir ${u}`);const e=await y(E,r,t,{localDir:`${t.localDownloadDir}${u}`,remoteDir:t.remoteDirTarget});return o.info("----->\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5230\u672C\u5730\u5B8C\u6210"),e}async function m(E){o.info("----->\u5F00\u59CB\u5728\u670D\u52A1\u5668\u7AEF\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE...");const u=s().format("YYYY-MM-DD_HHmmss"),e=`${K}${u}`;await a(E,r,t,{path:e});const H=await i(E,r,t,`cp -ra ${t.remoteDirTarget}/. ${e}`);return o.info("----->\u5728\u670D\u52A1\u5668\u7AEF\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5B8C\u6210"),H}async function f(E){return o.info("----->\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u548C\u76EE\u6807\u76EE\u5F55..."),i(E,r,t,`ls ${F}`,async u=>{try{u.includes(C)||(o.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u4E34\u65F6\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55..."),await a(E,r,t,{path:t.remoteDirTemp}),o.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55\u6210\u529F")),u.includes(T)||(o.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u76EE\u6807\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u76EE\u6807\u76EE\u5F55..."),await a(E,r,t,{path:t.remoteDirTarget}),o.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u6807\u76EE\u5F55\u6210\u529F"))}catch(e){throw e}})}async function A(E){o.info("----->\u5F00\u59CB\u9690\u85CF\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6...");const u=await i(E,r,t,`mv ${W} ${j}`);return o.info("----->\u9690\u85CF\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6\u5B8C\u6210"),u}async function c(E){o.info("----->\u5F00\u59CB\u8FD8\u539F\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6...");const u=await i(E,r,t,`mv ${V} ${U}`);return o.info("----->\u8FD8\u539F\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6\u5B8C\u6210"),u}async function S(E){o.info("----->\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const u=await i(E,r,t,`rm -rf ${t.remoteDirTemp}/*`);return o.info("----->\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210"),u}async function _(E){o.info("----->\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const u=await d(E,r,t,{localDir:t.localDeployDir,remoteDir:t.remoteDirTemp});return o.info("----->\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210"),u}async function p(E){o.info("----->\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55...");const u=await i(E,r,t,`rm -rf ${t.remoteDirTarget}/*`);return o.info("----->\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210"),u}async function R(E){o.info("----->\u5F00\u59CB\u79FB\u52A8\u4E34\u65F6\u76EE\u5F55\u6587\u4EF6\u5230\u76EE\u6807\u76EE\u5F55...");const u=await i(E,r,t,`mv ${t.remoteDirTemp}/* ${t.remoteDirTarget}/`);return o.info("----->\u6587\u4EF6\u79FB\u52A8\u5B8C\u6210"),u}async function q(E=!1){let u;try{if(!w.existsSync(t.localDeployDir))throw new Error(`\u672C\u5730\u76EE\u5F55 ${t.localDeployDir} \u4E0D\u5B58\u5728`);return E&&await l(),u=await n(D),await f(u),await m(u),await S(u),await _(u),await p(u),await A(u),await R(u),o.info("\u90E8\u7F72\u5B8C\u6210!"),await c(u),!0}catch(e){return o.error("\u90E8\u7F72\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF:",e),!1}finally{o.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),u?.dispose()}}async function z(){let E;try{E=await n(D),await c(E),o.info("\u5F00\u542F\u5065\u5EB7\u68C0\u67E5\u6210\u529F!")}catch(u){o.error("\u5F00\u542F\u5065\u5EB7\u68C0\u67E5\u65F6\u51FA\u73B0\u9519\u8BEF:",u)}finally{o.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),E?.dispose()}}async function Q(){let E;try{E=await n(D),await A(E),o.info("----->\u5173\u95ED\u5065\u5EB7\u68C0\u67E5\u6210\u529F!")}catch(u){o.error("\u5173\u95ED\u5065\u5EB7\u68C0\u67E5\u65F6\u51FA\u73B0\u9519\u8BEF:",u)}finally{o.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),E?.dispose()}}process.on("uncaughtException",E=>{o.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u6355\u83B7\u7684\u5F02\u5E38: ${E}`)}),process.on("unhandledRejection",(E,u)=>{o.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u5904\u7406\u7684\u62D2\u7EDD: ${u} \u539F\u56E0\u662F: ${E}`)});export{J as backupLocal,m as backupRemote,l as buildProject,f as checkRemoteDirExist,p as clearRemoteTargetDir,S as clearRemoteTempDir,q as deployLinuxBastion,Q as disableLinuxBastionHealthCheck,c as displayHealthFile,z as enableLinuxBastionHealthCheck,A as hideHealthFile,R as moveRemoteTempDirToTargetDir,_ as uploadToRemoteTempDir};
