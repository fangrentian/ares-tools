"use strict";const u=require("fs"),f=require("dayjs"),utils_ssh=require("./ssh.cjs"),utils_childProcess=require("./childProcess.cjs"),utils_logger=require("./logger.cjs");function _interopDefaultCompat(e){return e&&typeof e=="object"&&"default"in e?e.default:e}const u__default=_interopDefaultCompat(u),f__default=_interopDefaultCompat(f),{BUILD_MODE:T,PROJECT_DIR:E,LOCAL_DEPLOY_DIR:R,LOCAL_DOWNLOAD_DIR:w,BASTION_SSH_HOST:A,BASTION_SSH_USER:P,BASTION_SSH_PASSWORD:I,BASTION_SSH_PORT:$,BASTION_SSH_PRIVATE_KEY:g,TARGET_SSH_HOST:h,TARGET_SSH_USER:x,TARGET_SSH_PASSWORD:O,TARGET_SSH_PORT:L,TARGET_SSH_PRIVATE_KEY:N,TARGET_BK_DIR:G,TARGET_DIR:S,TARGET_FOLDER_TEMP:D,TARGET_FOLDER_TARGET:p,TARGET_HEALTH_DIR:b,TARGET_HIDE_HEALTH_FILE_DIR:v,TARGET_HEALTH_FILE:C,TARGET_HEALTH_HIDDEN_FILE:B}=process.env,l={host:A,port:$,username:P,password:I,privateKey:g},t={host:h,port:L,username:x,password:O,privateKey:N,localDeployDir:R,localDownloadDir:w,remoteDirTemp:`${S}${D}`,remoteDirTarget:`${S}${p}`},a={dstIP:t.host,dstPort:t.port};async function buildProject(){const e=T?`build:${T}`:"build";utils_logger.logger.info("----->\u5F00\u59CB\u6253\u5305\u9879\u76EE...");const r=await utils_childProcess.execProjectPNPMCommand(E,e);return utils_logger.logger.info("----->\u6253\u5305\u9879\u76EE\u5B8C\u6210"),r}async function backupLocal(e){utils_logger.logger.info("----->\u5F00\u59CB\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5230\u672C\u5730...");const r=f__default().format("YYYY-MM-DD_HHmmss");await utils_childProcess.execCommandUnderDirectory(t.localDownloadDir,`mkdir ${r}`);const o=await utils_ssh.getDirectoryFromIntraServer(e,a,t,{localDir:`${t.localDownloadDir}${r}`,remoteDir:t.remoteDirTarget});return utils_logger.logger.info("----->\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5230\u672C\u5730\u5B8C\u6210"),o}async function backupRemote(e){utils_logger.logger.info("----->\u5F00\u59CB\u5728\u670D\u52A1\u5668\u7AEF\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE...");const r=f__default().format("YYYY-MM-DD_HHmmss"),o=`${G}${r}`;await utils_ssh.makeDirectoryOnIntraServer(e,a,t,{path:o});const i=await utils_ssh.execIntraServerCommand(e,a,t,`cp -ra ${t.remoteDirTarget}/. ${o}`);return utils_logger.logger.info("----->\u5728\u670D\u52A1\u5668\u7AEF\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5B8C\u6210"),i}async function checkRemoteDirExist(e){return utils_logger.logger.info("----->\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u548C\u76EE\u6807\u76EE\u5F55..."),utils_ssh.execIntraServerCommand(e,a,t,`ls ${S}`,async r=>{try{r.includes(D)||(utils_logger.logger.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u4E34\u65F6\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55..."),await utils_ssh.makeDirectoryOnIntraServer(e,a,t,{path:t.remoteDirTemp}),utils_logger.logger.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55\u6210\u529F")),r.includes(p)||(utils_logger.logger.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u76EE\u6807\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u76EE\u6807\u76EE\u5F55..."),await utils_ssh.makeDirectoryOnIntraServer(e,a,t,{path:t.remoteDirTarget}),utils_logger.logger.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u6807\u76EE\u5F55\u6210\u529F"))}catch(o){throw o}})}async function hideHealthFile(e){utils_logger.logger.info("----->\u5F00\u59CB\u9690\u85CF\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6...");const r=await utils_ssh.execIntraServerCommand(e,a,t,`mv ${C} ${v}`);return utils_logger.logger.info("----->\u9690\u85CF\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6\u5B8C\u6210"),r}async function displayHealthFile(e){utils_logger.logger.info("----->\u5F00\u59CB\u8FD8\u539F\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6...");const r=await utils_ssh.execIntraServerCommand(e,a,t,`mv ${B} ${b}`);return utils_logger.logger.info("----->\u8FD8\u539F\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6\u5B8C\u6210"),r}async function clearRemoteTempDir(e){utils_logger.logger.info("----->\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const r=await utils_ssh.execIntraServerCommand(e,a,t,`rm -rf ${t.remoteDirTemp}/*`);return utils_logger.logger.info("----->\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210"),r}async function uploadToRemoteTempDir(e){utils_logger.logger.info("----->\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const r=await utils_ssh.putDirectoryToIntraServer(e,a,t,{localDir:t.localDeployDir,remoteDir:t.remoteDirTemp});return utils_logger.logger.info("----->\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210"),r}async function clearRemoteTargetDir(e){utils_logger.logger.info("----->\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55...");const r=await utils_ssh.execIntraServerCommand(e,a,t,`rm -rf ${t.remoteDirTarget}/*`);return utils_logger.logger.info("----->\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210"),r}async function moveRemoteTempDirToTargetDir(e){utils_logger.logger.info("----->\u5F00\u59CB\u79FB\u52A8\u4E34\u65F6\u76EE\u5F55\u6587\u4EF6\u5230\u76EE\u6807\u76EE\u5F55...");const r=await utils_ssh.execIntraServerCommand(e,a,t,`mv ${t.remoteDirTemp}/* ${t.remoteDirTarget}/`);return utils_logger.logger.info("----->\u6587\u4EF6\u79FB\u52A8\u5B8C\u6210"),r}async function deployLinuxBastion(e=!1){let r;try{if(!u__default.existsSync(t.localDeployDir))throw new Error(`\u672C\u5730\u76EE\u5F55 ${t.localDeployDir} \u4E0D\u5B58\u5728`);return e&&await buildProject(),r=await utils_ssh.getBastionSSHClient(l),await checkRemoteDirExist(r),await backupRemote(r),await clearRemoteTempDir(r),await uploadToRemoteTempDir(r),await clearRemoteTargetDir(r),await hideHealthFile(r),await moveRemoteTempDirToTargetDir(r),utils_logger.logger.info("\u90E8\u7F72\u5B8C\u6210!"),await displayHealthFile(r),!0}catch(o){return utils_logger.logger.error("\u90E8\u7F72\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF:",o),!1}finally{utils_logger.logger.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),r?.dispose()}}async function enableLinuxBastionHealthCheck(){let e;try{e=await utils_ssh.getBastionSSHClient(l),await displayHealthFile(e),utils_logger.logger.info("\u5F00\u542F\u5065\u5EB7\u68C0\u67E5\u6210\u529F!")}catch(r){utils_logger.logger.error("\u5F00\u542F\u5065\u5EB7\u68C0\u67E5\u65F6\u51FA\u73B0\u9519\u8BEF:",r)}finally{utils_logger.logger.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),e?.dispose()}}async function disableLinuxBastionHealthCheck(){let e;try{e=await utils_ssh.getBastionSSHClient(l),await hideHealthFile(e),utils_logger.logger.info("----->\u5173\u95ED\u5065\u5EB7\u68C0\u67E5\u6210\u529F!")}catch(r){utils_logger.logger.error("\u5173\u95ED\u5065\u5EB7\u68C0\u67E5\u65F6\u51FA\u73B0\u9519\u8BEF:",r)}finally{utils_logger.logger.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),e?.dispose()}}process.on("uncaughtException",e=>{utils_logger.logger.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u6355\u83B7\u7684\u5F02\u5E38: ${e}`)}),process.on("unhandledRejection",(e,r)=>{utils_logger.logger.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u5904\u7406\u7684\u62D2\u7EDD: ${r} \u539F\u56E0\u662F: ${e}`)}),exports.backupLocal=backupLocal,exports.backupRemote=backupRemote,exports.buildProject=buildProject,exports.checkRemoteDirExist=checkRemoteDirExist,exports.clearRemoteTargetDir=clearRemoteTargetDir,exports.clearRemoteTempDir=clearRemoteTempDir,exports.deployLinuxBastion=deployLinuxBastion,exports.disableLinuxBastionHealthCheck=disableLinuxBastionHealthCheck,exports.displayHealthFile=displayHealthFile,exports.enableLinuxBastionHealthCheck=enableLinuxBastionHealthCheck,exports.hideHealthFile=hideHealthFile,exports.moveRemoteTempDirToTargetDir=moveRemoteTempDirToTargetDir,exports.uploadToRemoteTempDir=uploadToRemoteTempDir;
