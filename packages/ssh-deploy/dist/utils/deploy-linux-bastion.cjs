"use strict";const d=require("fs"),u=require("dayjs"),utils_logger=require("./logger.cjs"),utils_common=require("./common.cjs"),utils_ssh=require("./ssh.cjs"),utils_childProcess=require("./childProcess.cjs");function _interopDefaultCompat(r){return r&&typeof r=="object"&&"default"in r?r.default:r}const d__default=_interopDefaultCompat(d),u__default=_interopDefaultCompat(u);async function backupLocal(r,e,t){const{localDownloadDir:o,remoteDir:i}=e;utils_logger.logger.info("\u5F00\u59CB\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5230\u672C\u5730...");const n=u__default().format("YYYY-MM-DD_HHmmss");await utils_childProcess.execCommandUnderDirectory(o,`mkdir ${n}`);const a=await utils_ssh.getDirectoryFromIntraServer(r,t,e,{localDir:`${o}${n}`,remoteDir:i});return utils_logger.logger.info("\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5230\u672C\u5730\u5B8C\u6210"),a}async function backupRemote(r,e,t){const{remoteBackupDir:o,remoteDir:i}=e;utils_logger.logger.info("\u5F00\u59CB\u5728\u670D\u52A1\u5668\u7AEF\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE...");const n=u__default().format("YYYY-MM-DD_HHmmss"),a=`${o}${n}`;await utils_ssh.makeDirectoryOnIntraServer(r,t,e,{path:a});const E=await utils_ssh.execIntraServerCommand(r,t,e,`cp -ra ${i}. ${a}`);return utils_logger.logger.info("\u5728\u670D\u52A1\u5668\u7AEF\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5B8C\u6210"),E}async function checkRemoteDirExist(r,e,t){const{remoteDir:o,remoteDirTemp:i,remoteBackupDir:n}=e;if(utils_logger.logger.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55..."),(await utils_ssh.execIntraServerCommand(r,t,e,`test -d ${o}`)).code!==0)try{utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u76EE\u6807\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u76EE\u6807\u76EE\u5F55..."),await utils_ssh.makeDirectoryOnIntraServer(r,t,e,{path:o}),utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u6807\u76EE\u5F55\u6210\u529F")}catch(E){throw E}utils_logger.logger.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const a=await utils_ssh.execIntraServerCommand(r,t,e,`test -d ${i}`);if(a.code!==0)try{utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u4E34\u65F6\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55..."),await utils_ssh.makeDirectoryOnIntraServer(r,t,e,{path:i}),utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55\u6210\u529F")}catch(E){throw E}if(utils_logger.logger.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u5907\u4EFD\u76EE\u5F55..."),await utils_ssh.execIntraServerCommand(r,t,e,`test -d ${n}`),a.code!==0)try{utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u5907\u4EFD\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u5907\u4EFD\u76EE\u5F55..."),await utils_ssh.makeDirectoryOnIntraServer(r,t,e,{path:n}),utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u5907\u4EFD\u76EE\u5F55\u6210\u529F")}catch(E){throw E}}async function hideHealthFile(r,e,t){const{remoteHealthFile:o,remoteHideHealthFileDir:i}=e;utils_logger.logger.info("\u5F00\u59CB\u9690\u85CF\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6...");const n=await utils_ssh.execIntraServerCommand(r,t,e,`mv ${o} ${i}`);return utils_logger.logger.info("\u9690\u85CF\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6\u5B8C\u6210"),n}async function displayHealthFile(r,e,t){const{remoteHealthHiddenFile:o,remoteHealthDir:i}=e;utils_logger.logger.info("\u5F00\u59CB\u8FD8\u539F\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6...");const n=await utils_ssh.execIntraServerCommand(r,t,e,`mv ${o} ${i}`);return utils_logger.logger.info("\u8FD8\u539F\u88AB\u5065\u5EB7\u68C0\u67E5\u7684\u6587\u4EF6\u5B8C\u6210"),n}async function clearRemoteTempDir(r,e,t){const{remoteDirTemp:o}=e;utils_logger.logger.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const i=await utils_ssh.execIntraServerCommand(r,t,e,`rm -rf ${o}*`);return utils_logger.logger.info("\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210"),i}async function uploadToRemoteTempDir(r,e,t){const{localDeployDir:o,remoteDirTemp:i}=e;utils_logger.logger.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55...");const n=await utils_ssh.putDirectoryToIntraServer(r,t,e,{localDir:o,remoteDir:i});return utils_logger.logger.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210"),n}async function clearRemoteTargetDir(r,e,t){const{remoteDir:o}=e;utils_logger.logger.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55...");const i=await utils_ssh.execIntraServerCommand(r,t,e,`rm -rf ${o}*`);return utils_logger.logger.info("\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210"),i}async function moveRemoteTempDirToTargetDir(r,e,t){const{remoteDir:o,remoteDirTemp:i}=e;utils_logger.logger.info("\u5F00\u59CB\u79FB\u52A8\u4E34\u65F6\u76EE\u5F55\u6587\u4EF6\u5230\u76EE\u6807\u76EE\u5F55...");const n=await utils_ssh.execIntraServerCommand(r,t,e,`mv ${i}* ${o}`);return utils_logger.logger.info("\u6587\u4EF6\u79FB\u52A8\u5B8C\u6210"),n}async function deployToLinuxBastionInternalServer(r={},e={},t={}){let o;const i=utils_common.getBuildConfig(r),n=utils_common.getBastionConfig(e),a=utils_common.getBastionTargetConfig(t),E=utils_common.getBastionChannelConfig(a);try{const{localDeployDir:c}=a;if(!d__default.existsSync(c))throw new Error(`\u672C\u5730\u76EE\u5F55 ${c} \u4E0D\u5B58\u5728`);return i.build&&await utils_common.buildProject(i),o=await utils_ssh.getBastionSSHClient(n),await checkRemoteDirExist(o,a,E),await backupRemote(o,a,E),await clearRemoteTempDir(o,a,E),await uploadToRemoteTempDir(o,a,E),await clearRemoteTargetDir(o,a,E),await moveRemoteTempDirToTargetDir(o,a,E),utils_logger.logger.info("\u90E8\u7F72\u5B8C\u6210!"),!0}catch(c){return utils_logger.logger.error("\u90E8\u7F72\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF:",c),!1}finally{utils_logger.logger.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),o?.dispose()}}async function enableLinuxBastionHealthCheck(r={},e={}){let t;const o=utils_common.getBastionConfig(r),i=utils_common.getBastionTargetConfig(e),n=utils_common.getBastionChannelConfig(i);try{t=await utils_ssh.getBastionSSHClient(o),await displayHealthFile(t,i,n),utils_logger.logger.info("\u5F00\u542F\u5065\u5EB7\u68C0\u67E5\u6210\u529F!")}catch(a){utils_logger.logger.error("\u5F00\u542F\u5065\u5EB7\u68C0\u67E5\u65F6\u51FA\u73B0\u9519\u8BEF:",a)}finally{utils_logger.logger.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),t?.dispose()}}async function disableLinuxBastionHealthCheck(r={},e={}){let t;const o=utils_common.getBastionConfig(r),i=utils_common.getBastionTargetConfig(e),n=utils_common.getBastionChannelConfig(i);try{t=await utils_ssh.getBastionSSHClient(o),await hideHealthFile(t,i,n),utils_logger.logger.info("\u5173\u95ED\u5065\u5EB7\u68C0\u67E5\u6210\u529F!")}catch(a){utils_logger.logger.error("\u5173\u95ED\u5065\u5EB7\u68C0\u67E5\u65F6\u51FA\u73B0\u9519\u8BEF:",a)}finally{utils_logger.logger.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),t?.dispose()}}process.on("uncaughtException",r=>{utils_logger.logger.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u6355\u83B7\u7684\u5F02\u5E38: ${r}`)}),process.on("unhandledRejection",(r,e)=>{utils_logger.logger.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u5904\u7406\u7684\u62D2\u7EDD: ${e} \u539F\u56E0\u662F: ${r}`)}),exports.backupLocal=backupLocal,exports.backupRemote=backupRemote,exports.checkRemoteDirExist=checkRemoteDirExist,exports.clearRemoteTargetDir=clearRemoteTargetDir,exports.clearRemoteTempDir=clearRemoteTempDir,exports.deployToLinuxBastionInternalServer=deployToLinuxBastionInternalServer,exports.disableLinuxBastionHealthCheck=disableLinuxBastionHealthCheck,exports.displayHealthFile=displayHealthFile,exports.enableLinuxBastionHealthCheck=enableLinuxBastionHealthCheck,exports.hideHealthFile=hideHealthFile,exports.moveRemoteTempDirToTargetDir=moveRemoteTempDirToTargetDir,exports.uploadToRemoteTempDir=uploadToRemoteTempDir;
