"use strict";const S=require("path"),nodeSsh=require("node-ssh"),p=require("iconv-lite"),utils_logger=require("./logger.cjs");function _interopDefaultCompat(e){return e&&typeof e=="object"&&"default"in e?e.default:e}const S__default=_interopDefaultCompat(S),p__default=_interopDefaultCompat(p);async function getSSHClient(e){const{host:o,port:r,username:t,password:u,privateKey:i}=e,n=await new nodeSsh.NodeSSH().connect({host:o,port:Number(r),username:t,password:u,privateKey:i});return n.connection.on("error",c=>{c.code==="ECONNRESET"?utils_logger.logger.info("SSH\u8FDE\u63A5\u88AB\u91CD\u7F6E"):utils_logger.logger.error("SSH\u53D1\u751F\u5F02\u5E38:",c)}),n.connection.on("end",()=>{utils_logger.logger.info("SSH\u8FDE\u63A5\u7ED3\u675F")}),n.connection.on("close",()=>{utils_logger.logger.info("SSH\u8FDE\u63A5\u5173\u95ED")}),n}async function getBastionSSHClient(e){utils_logger.logger.info("\u5F00\u59CB\u8FDE\u63A5\u5230\u8FDC\u7A0B\u5821\u5792\u673A...");const o=await getSSHClient(e);return utils_logger.logger.info("\u8FDE\u63A5\u5230\u8FDC\u7A0B\u5821\u5792\u673A\u6210\u529F"),o}async function getBastionChannel(e,o){const{srcIP:r="127.0.0.1",srcPort:t=0,dstIP:u,dstPort:i}=o;utils_logger.logger.info("\u5F00\u59CB\u901A\u8FC7\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u96A7\u9053...");const n=await e.forwardOut(r,Number(t),u,Number(i));return utils_logger.logger.info("\u901A\u8FC7\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u96A7\u9053\u6210\u529F"),n}async function getIntraServerSSHClient(e,o){const{username:r,password:t}=o,u=new nodeSsh.NodeSSH;return utils_logger.logger.info("\u5F00\u59CB\u8FDE\u63A5\u5230\u5185\u90E8\u76EE\u6807\u670D\u52A1\u5668..."),await u.connect({sock:e,username:r,password:t}),utils_logger.logger.info("\u8FDE\u63A5\u5230\u5185\u90E8\u76EE\u6807\u670D\u52A1\u5668\u6210\u529F"),u}async function execIntraServerCommand(e,o,r,t,u){const i=await getBastionChannel(e,o),n=await getIntraServerSSHClient(i,r);utils_logger.logger.info(`\u6267\u884C\u547D\u4EE4\u3010 ${t} \u3011`);const c=await n.execCommand(t),a=/\r?\n/,E=c.stdout.split(a);utils_logger.logger.info(`\u547D\u4EE4\u3010 ${t} \u3011\u6267\u884C\u7ED3\u679C`,E),typeof u=="function"&&await u(E),n.dispose(),utils_logger.logger.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),i.close(),utils_logger.logger.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function putDirectoryToIntraServer(e,o,r,t){const u=await getBastionChannel(e,o),i=await getIntraServerSSHClient(u,r);utils_logger.logger.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:n,remoteDir:c}=t;await i.putDirectory(n,c,{recursive:!0,concurrency:10,validate:function(a){return S__default.basename(a).substr(0,1)!=="."},tick:function(a,E,s){s?utils_logger.logger.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${a}`):utils_logger.logger.log(`\u4E0A\u4F20\u6210\u529F: ${a}`)}}),utils_logger.logger.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210"),i.dispose(),utils_logger.logger.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),u.close(),utils_logger.logger.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function getDirectoryFromIntraServer(e,o,r,t){const u=await getBastionChannel(e,o),i=await getIntraServerSSHClient(u,r);utils_logger.logger.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:n,remoteDir:c}=t;await i.getDirectory(n,c,{recursive:!0,concurrency:10,validate:function(a){return S__default.basename(a).substr(0,1)!=="."},tick:function(a,E,s){s?utils_logger.logger.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${a}`):utils_logger.logger.log(`\u4E0B\u8F7D\u6210\u529F: ${a}`)}}),utils_logger.logger.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210"),i.dispose(),utils_logger.logger.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),u.close(),utils_logger.logger.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function makeDirectoryOnIntraServer(e,o,r,t){const u=await getBastionChannel(e,o),i=await getIntraServerSSHClient(u,r);utils_logger.logger.info("\u5F00\u59CB\u5728\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:n,method:c,givenSftp:a}=t;await i.mkdir(n,c,a),utils_logger.logger.info("\u5728\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210"),i.dispose(),utils_logger.logger.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),u.close(),utils_logger.logger.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function execRemoteServerCommand(e,o,r={},t){utils_logger.logger.info(`\u6267\u884C\u547D\u4EE4\u3010 ${o} \u3011`);const u=await e.execCommand(o,{encoding:"utf8",...r}),i=/\r?\n/,n=u.stdout.split(i);utils_logger.logger.info(`\u547D\u4EE4\u3010 ${o} \u3011\u6267\u884C\u7ED3\u679C`,n),typeof t=="function"&&await t(n)}async function putDirectoryToRemoteServer(e,o){utils_logger.logger.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:r,remoteDir:t}=o;await e.putDirectory(r,t,{recursive:!0,concurrency:10,validate:function(u){return S__default.basename(u).substr(0,1)!=="."},tick:function(u,i,n){n?utils_logger.logger.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${u}`):utils_logger.logger.log(`\u4E0A\u4F20\u6210\u529F: ${u}`)}}),utils_logger.logger.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210")}async function getDirectoryFromRemoteServer(e,o){utils_logger.logger.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:r,remoteDir:t}=o;await e.getDirectory(r,t,{recursive:!0,concurrency:10,validate:function(u){return S__default.basename(u).substr(0,1)!=="."},tick:function(u,i,n){n?utils_logger.logger.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${u}`):utils_logger.logger.log(`\u4E0B\u8F7D\u6210\u529F: ${u}`)}}),utils_logger.logger.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210")}async function makeDirectoryOnRemoteServer(e,o){utils_logger.logger.info("\u5F00\u59CB\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:r,method:t,givenSftp:u}=o;await e.mkdir(r,t,u),utils_logger.logger.info("\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210")}async function execRemoteWindowServerCommand(e,o,r={},t){utils_logger.logger.info(`\u6267\u884C\u547D\u4EE4\u3010 ${o} \u3011`);const u=await e.execCommand(o,{encoding:"binary",...r}),i=Buffer.isBuffer(u.stdout)?p__default.decode(u.stdout,"GBK"):u.stdout.toString(),n=/\r?\n/,c=i.split(n);utils_logger.logger.info(`\u547D\u4EE4\u3010 ${o} \u3011\u6267\u884C\u7ED3\u679C`,c),typeof t=="function"&&await t(c)}async function putDirectoryToRemoteWindowServer(e,o){utils_logger.logger.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:r,remoteDir:t}=o;await e.putDirectory(r,t,{recursive:!0,concurrency:10,validate:function(u){return S__default.basename(u).substr(0,1)!=="."},tick:function(u,i,n){n?utils_logger.logger.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${u}`):utils_logger.logger.log(`\u4E0A\u4F20\u6210\u529F: ${u}`)}}),utils_logger.logger.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210")}async function getDirectoryFromRemoteWindowServer(e,o){utils_logger.logger.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:r,remoteDir:t}=o;await e.getDirectory(r,t,{recursive:!0,concurrency:10,validate:function(u){return S__default.basename(u).substr(0,1)!=="."},tick:function(u,i,n){n?utils_logger.logger.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${u}`):utils_logger.logger.log(`\u4E0B\u8F7D\u6210\u529F: ${u}`)}}),utils_logger.logger.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210")}async function makeDirectoryOnRemoteWindowServer(e,o){utils_logger.logger.info("\u5F00\u59CB\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:r,method:t,givenSftp:u}=o;await e.mkdir(r,t,u),utils_logger.logger.info("\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210")}async function clearRemoteWindowServerDir(e,o){utils_logger.logger.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55...");const r=`tem${new Date().getTime()}`;await execRemoteWindowServerCommand(e,`mkdir ${o}\\${r}`),await execRemoteWindowServerCommand(e,`robocopy ${o}\\${r} ${o} /mir`),await execRemoteWindowServerCommand(e,`rmdir ${o}\\${r}`),utils_logger.logger.info("\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210")}exports.clearRemoteWindowServerDir=clearRemoteWindowServerDir,exports.execIntraServerCommand=execIntraServerCommand,exports.execRemoteServerCommand=execRemoteServerCommand,exports.execRemoteWindowServerCommand=execRemoteWindowServerCommand,exports.getBastionChannel=getBastionChannel,exports.getBastionSSHClient=getBastionSSHClient,exports.getDirectoryFromIntraServer=getDirectoryFromIntraServer,exports.getDirectoryFromRemoteServer=getDirectoryFromRemoteServer,exports.getDirectoryFromRemoteWindowServer=getDirectoryFromRemoteWindowServer,exports.getIntraServerSSHClient=getIntraServerSSHClient,exports.getSSHClient=getSSHClient,exports.makeDirectoryOnIntraServer=makeDirectoryOnIntraServer,exports.makeDirectoryOnRemoteServer=makeDirectoryOnRemoteServer,exports.makeDirectoryOnRemoteWindowServer=makeDirectoryOnRemoteWindowServer,exports.putDirectoryToIntraServer=putDirectoryToIntraServer,exports.putDirectoryToRemoteServer=putDirectoryToRemoteServer,exports.putDirectoryToRemoteWindowServer=putDirectoryToRemoteWindowServer;
