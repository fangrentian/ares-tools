"use strict";const d=require("path"),nodeSsh=require("node-ssh"),f=require("iconv-lite"),utils_logger=require("./logger.cjs");function _interopDefaultCompat(o){return o&&typeof o=="object"&&"default"in o?o.default:o}const d__default=_interopDefaultCompat(d),f__default=_interopDefaultCompat(f);async function getSSHClient(o){const{host:e,port:r,username:t,password:u,privateKey:i}=o,n=await new nodeSsh.NodeSSH().connect({host:e,port:Number(r),username:t,password:u,privateKey:i});return n.connection.on("error",E=>{E.code==="ECONNRESET"?utils_logger.logger.info("SSH\u8FDE\u63A5\u88AB\u91CD\u7F6E"):utils_logger.logger.error("SSH\u53D1\u751F\u5F02\u5E38:",E)}),n.connection.on("end",()=>{utils_logger.logger.info("SSH\u8FDE\u63A5\u7ED3\u675F")}),n.connection.on("close",()=>{utils_logger.logger.info("SSH\u8FDE\u63A5\u5173\u95ED")}),n}async function getBastionSSHClient(o){utils_logger.logger.info("\u5F00\u59CB\u8FDE\u63A5\u5230\u8FDC\u7A0B\u5821\u5792\u673A...");const e=await getSSHClient(o);return utils_logger.logger.info("\u8FDE\u63A5\u5230\u8FDC\u7A0B\u5821\u5792\u673A\u6210\u529F"),e}async function getBastionChannel(o,e){const{srcIP:r="127.0.0.1",srcPort:t=0,dstIP:u,dstPort:i}=e;utils_logger.logger.info("\u5F00\u59CB\u901A\u8FC7\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u96A7\u9053...");const n=await o.forwardOut(r,Number(t),u,Number(i));return utils_logger.logger.info("\u901A\u8FC7\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u96A7\u9053\u6210\u529F"),n}async function getIntraServerSSHClient(o,e){const{username:r,password:t}=e,u=new nodeSsh.NodeSSH;return utils_logger.logger.info("\u5F00\u59CB\u8FDE\u63A5\u5230\u5185\u90E8\u76EE\u6807\u670D\u52A1\u5668..."),await u.connect({sock:o,username:r,password:t}),utils_logger.logger.info("\u8FDE\u63A5\u5230\u5185\u90E8\u76EE\u6807\u670D\u52A1\u5668\u6210\u529F"),u}async function execIntraServerCommand(o,e,r,t,u){const i=await getBastionChannel(o,e),n=await getIntraServerSSHClient(i,r);utils_logger.logger.info(`\u6267\u884C\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u547D\u4EE4\u3010 ${t} \u3011`);const E=await n.execCommand(t),{stderr:c}=E,a=/\r?\n/,s=E.stdout.split(a);return utils_logger.logger.info(`\u6267\u884C\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u547D\u4EE4\u3010 ${t} \u3011\u5B8C\u6210`),c&&utils_logger.logger.error("\u6267\u884C\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u547D\u4EE4\u3010 ${command} \u3011\u53D1\u751F\u5F02\u5E38:",c),typeof u=="function"&&await u(s),n.dispose(),utils_logger.logger.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),i.close(),utils_logger.logger.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL"),E}async function putDirectoryToIntraServer(o,e,r,t){const u=await getBastionChannel(o,e),i=await getIntraServerSSHClient(u,r);utils_logger.logger.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668...");const{localDir:n,remoteDir:E}=t;await i.putDirectory(n,E,{recursive:!0,concurrency:10,validate:function(c){return d__default.basename(c).substr(0,1)!=="."},tick:function(c,a,s){s?utils_logger.logger.error("\u4E0A\u4F20\u5230\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${c}`):utils_logger.logger.log(`\u4E0A\u4F20\u5230\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u6210\u529F: \u672C\u5730\u6587\u4EF6${c}`)}}),utils_logger.logger.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u5B8C\u6210"),i.dispose(),utils_logger.logger.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),u.close(),utils_logger.logger.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function getDirectoryFromIntraServer(o,e,r,t){const u=await getBastionChannel(o,e),i=await getIntraServerSSHClient(u,r);utils_logger.logger.info("\u5F00\u59CB\u4ECE\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:n,remoteDir:E}=t;await i.getDirectory(n,E,{recursive:!0,concurrency:10,validate:function(c){return d__default.basename(c).substr(0,1)!=="."},tick:function(c,a,s){s?utils_logger.logger.error("\u4ECE\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${a}`):utils_logger.logger.log(`\u4ECE\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0B\u8F7D\u6210\u529F: \u8FDC\u7A0B\u6587\u4EF6${a}`)}}),utils_logger.logger.info("\u4ECE\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210"),i.dispose(),utils_logger.logger.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),u.close(),utils_logger.logger.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function makeDirectoryOnIntraServer(o,e,r,t){const u=await getBastionChannel(o,e),i=await getIntraServerSSHClient(u,r);utils_logger.logger.info("\u5F00\u59CB\u5728\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:n,method:E,givenSftp:c}=t;await i.mkdir(n,E,c),utils_logger.logger.info("\u5728\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210"),i.dispose(),utils_logger.logger.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),u.close(),utils_logger.logger.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function execRemoteServerCommand(o,e,r={},t){utils_logger.logger.info(`\u6267\u884C\u547D\u4EE4\u3010 ${e} \u3011`);const u=await o.execCommand(e,{encoding:"utf8",...r}),{stderr:i}=u,n=/\r?\n/,E=u.stdout.split(n);utils_logger.logger.info(`\u6267\u884C\u547D\u4EE4\u3010 ${e} \u3011\u5B8C\u6210`),i&&utils_logger.logger.error(`\u6267\u884C\u547D\u4EE4 ${e} \u53D1\u751F\u5F02\u5E38`,i),typeof t=="function"&&await t(E)}async function putDirectoryToRemoteServer(o,e){utils_logger.logger.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:r,remoteDir:t}=e;await o.putDirectory(r,t,{recursive:!0,concurrency:10,validate:function(u){return d__default.basename(u).substr(0,1)!=="."},tick:function(u,i,n){n?utils_logger.logger.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${u}`):utils_logger.logger.log(`\u4E0A\u4F20\u6210\u529F: \u672C\u5730\u6587\u4EF6${u}`)}}),utils_logger.logger.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210")}async function getDirectoryFromRemoteServer(o,e){utils_logger.logger.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:r,remoteDir:t}=e;await o.getDirectory(r,t,{recursive:!0,concurrency:10,validate:function(u){return d__default.basename(u).substr(0,1)!=="."},tick:function(u,i,n){n?utils_logger.logger.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${i}`):utils_logger.logger.log(`\u4E0B\u8F7D\u6210\u529F: \u8FDC\u7A0B\u6587\u4EF6${i}`)}}),utils_logger.logger.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210")}async function makeDirectoryOnRemoteServer(o,e){utils_logger.logger.info("\u5F00\u59CB\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:r,method:t,givenSftp:u}=e;await o.mkdir(r,t,u),utils_logger.logger.info("\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210")}async function execRemoteWindowServerCommand(o,e,r={},t){utils_logger.logger.info(`\u6267\u884C\u547D\u4EE4\u3010 ${e} \u3011`);const u=await o.execCommand(e,{encoding:"binary",...r}),i=Buffer.isBuffer(u.stdout)?f__default.decode(u.stdout,"GBK"):u.stdout.toString(),n=Buffer.isBuffer(u.stderr)?f__default.decode(u.stderr,"GBK"):u.stderr.toString(),E=/\r?\n/,c=i.split(E);return utils_logger.logger.info(`\u6267\u884C\u547D\u4EE4\u3010 ${e} \u3011\u5B8C\u6210`),n&&utils_logger.logger.error(`\u6267\u884C\u547D\u4EE4 ${e} \u53D1\u751F\u5F02\u5E38`,n),typeof t=="function"&&await t(c),u}async function putDirectoryToRemoteWindowServer(o,e){utils_logger.logger.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:r,remoteDir:t}=e;await o.putDirectory(r,t,{recursive:!0,concurrency:10,validate:function(u){return d__default.basename(u).substr(0,1)!=="."},tick:function(u,i,n){n?utils_logger.logger.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${u}`):utils_logger.logger.log(`\u4E0A\u4F20\u6210\u529F: ${u}`)}}),utils_logger.logger.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210")}async function getDirectoryFromRemoteWindowServer(o,e){utils_logger.logger.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:r,remoteDir:t}=e;await o.getDirectory(r,t,{recursive:!0,concurrency:10,validate:function(u){return d__default.basename(u).substr(0,1)!=="."},tick:function(u,i,n){n?utils_logger.logger.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${u}`):utils_logger.logger.log(`\u4E0B\u8F7D\u6210\u529F: ${u}`)}}),utils_logger.logger.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210")}async function makeDirectoryOnRemoteWindowServer(o,e){utils_logger.logger.info("\u5F00\u59CB\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:r,method:t,givenSftp:u}=e;await o.mkdir(r,t,u),utils_logger.logger.info("\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210")}async function clearRemoteWindowServerDir(o,e){utils_logger.logger.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55...");const r=`tem${new Date().getTime()}`;await execRemoteWindowServerCommand(o,`mkdir ${e}${r}`),await execRemoteWindowServerCommand(o,`robocopy ${e}${r} ${e} /mir`),await execRemoteWindowServerCommand(o,`rmdir ${e}${r}`),utils_logger.logger.info("\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210")}exports.clearRemoteWindowServerDir=clearRemoteWindowServerDir,exports.execIntraServerCommand=execIntraServerCommand,exports.execRemoteServerCommand=execRemoteServerCommand,exports.execRemoteWindowServerCommand=execRemoteWindowServerCommand,exports.getBastionChannel=getBastionChannel,exports.getBastionSSHClient=getBastionSSHClient,exports.getDirectoryFromIntraServer=getDirectoryFromIntraServer,exports.getDirectoryFromRemoteServer=getDirectoryFromRemoteServer,exports.getDirectoryFromRemoteWindowServer=getDirectoryFromRemoteWindowServer,exports.getIntraServerSSHClient=getIntraServerSSHClient,exports.getSSHClient=getSSHClient,exports.makeDirectoryOnIntraServer=makeDirectoryOnIntraServer,exports.makeDirectoryOnRemoteServer=makeDirectoryOnRemoteServer,exports.makeDirectoryOnRemoteWindowServer=makeDirectoryOnRemoteWindowServer,exports.putDirectoryToIntraServer=putDirectoryToIntraServer,exports.putDirectoryToRemoteServer=putDirectoryToRemoteServer,exports.putDirectoryToRemoteWindowServer=putDirectoryToRemoteWindowServer;
