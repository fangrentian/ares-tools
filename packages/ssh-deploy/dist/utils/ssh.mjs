import s from"path";import{NodeSSH as B}from"node-ssh";import d from"iconv-lite";import{logger as u}from"./logger.mjs";async function m(n){const{host:e,port:t,username:r,password:o,privateKey:E}=n,i=await new B().connect({host:e,port:Number(t),username:r,password:o,privateKey:E});return i.connection.on("error",c=>{c.code==="ECONNRESET"?u.info("SSH\u8FDE\u63A5\u88AB\u91CD\u7F6E"):u.error("SSH\u53D1\u751F\u5F02\u5E38:",c)}),i.connection.on("end",()=>{u.info("SSH\u8FDE\u63A5\u7ED3\u675F")}),i.connection.on("close",()=>{u.info("SSH\u8FDE\u63A5\u5173\u95ED")}),i}async function y(n){u.info("\u5F00\u59CB\u8FDE\u63A5\u5230\u8FDC\u7A0B\u5821\u5792\u673A...");const e=await m(n);return u.info("\u8FDE\u63A5\u5230\u8FDC\u7A0B\u5821\u5792\u673A\u6210\u529F"),e}async function A(n,e){const{srcIP:t="127.0.0.1",srcPort:r=0,dstIP:o,dstPort:E}=e;u.info("\u5F00\u59CB\u901A\u8FC7\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u96A7\u9053...");const i=await n.forwardOut(t,Number(r),o,Number(E));return u.info("\u901A\u8FC7\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u96A7\u9053\u6210\u529F"),i}async function F(n,e){const{username:t,password:r}=e,o=new B;return u.info("\u5F00\u59CB\u8FDE\u63A5\u5230\u5185\u90E8\u76EE\u6807\u670D\u52A1\u5668..."),await o.connect({sock:n,username:t,password:r}),u.info("\u8FDE\u63A5\u5230\u5185\u90E8\u76EE\u6807\u670D\u52A1\u5668\u6210\u529F"),o}async function S(n,e,t,r,o){const E=await A(n,e),i=await F(E,t);u.info(`\u6267\u884C\u547D\u4EE4\u3010 ${r} \u3011`);const c=await i.execCommand(r),a=/\r?\n/,D=c.stdout.split(a);u.info(`\u547D\u4EE4\u3010 ${r} \u3011\u6267\u884C\u7ED3\u679C`,D),typeof o=="function"&&await o(D),i.dispose(),u.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),E.close(),u.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function w(n,e,t,r){const o=await A(n,e),E=await F(o,t);u.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:i,remoteDir:c}=r;await E.putDirectory(i,c,{recursive:!0,concurrency:10,validate:function(a){return s.basename(a).substr(0,1)!=="."},tick:function(a,D,f){f?u.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${a}`):u.log(`\u4E0A\u4F20\u6210\u529F: ${a}`)}}),u.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210"),E.dispose(),u.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),o.close(),u.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function l(n,e,t,r){const o=await A(n,e),E=await F(o,t);u.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:i,remoteDir:c}=r;await E.getDirectory(i,c,{recursive:!0,concurrency:10,validate:function(a){return s.basename(a).substr(0,1)!=="."},tick:function(a,D,f){f?u.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${a}`):u.log(`\u4E0B\u8F7D\u6210\u529F: ${a}`)}}),u.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210"),E.dispose(),u.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),o.close(),u.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function p(n,e,t,r){const o=await A(n,e),E=await F(o,t);u.info("\u5F00\u59CB\u5728\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:i,method:c,givenSftp:a}=r;await E.mkdir(i,c,a),u.info("\u5728\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210"),E.dispose(),u.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),o.close(),u.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function v(n,e,t={},r){u.info(`\u6267\u884C\u547D\u4EE4\u3010 ${e} \u3011`);const o=await n.execCommand(e,{encoding:"utf8",...t}),E=/\r?\n/,i=o.stdout.split(E);u.info(`\u547D\u4EE4\u3010 ${e} \u3011\u6267\u884C\u7ED3\u679C`,i),typeof r=="function"&&await r(i)}async function $(n,e){u.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:t,remoteDir:r}=e;await n.putDirectory(t,r,{recursive:!0,concurrency:10,validate:function(o){return s.basename(o).substr(0,1)!=="."},tick:function(o,E,i){i?u.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${o}`):u.log(`\u4E0A\u4F20\u6210\u529F: ${o}`)}}),u.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210")}async function g(n,e){u.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:t,remoteDir:r}=e;await n.getDirectory(t,r,{recursive:!0,concurrency:10,validate:function(o){return s.basename(o).substr(0,1)!=="."},tick:function(o,E,i){i?u.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${o}`):u.log(`\u4E0B\u8F7D\u6210\u529F: ${o}`)}}),u.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210")}async function b(n,e){u.info("\u5F00\u59CB\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:t,method:r,givenSftp:o}=e;await n.mkdir(t,r,o),u.info("\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210")}async function C(n,e,t={},r){u.info(`\u6267\u884C\u547D\u4EE4\u3010 ${e} \u3011`);const o=await n.execCommand(e,{encoding:"binary",...t}),E=Buffer.isBuffer(o.stdout)?d.decode(o.stdout,"GBK"):o.stdout.toString(),i=/\r?\n/,c=E.split(i);u.info(`\u547D\u4EE4\u3010 ${e} \u3011\u6267\u884C\u7ED3\u679C`,c),typeof r=="function"&&await r(c)}async function H(n,e){u.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:t,remoteDir:r}=e;await n.putDirectory(t,r,{recursive:!0,concurrency:10,validate:function(o){return s.basename(o).substr(0,1)!=="."},tick:function(o,E,i){i?u.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${o}`):u.log(`\u4E0A\u4F20\u6210\u529F: ${o}`)}}),u.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210")}async function k(n,e){u.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:t,remoteDir:r}=e;await n.getDirectory(t,r,{recursive:!0,concurrency:10,validate:function(o){return s.basename(o).substr(0,1)!=="."},tick:function(o,E,i){i?u.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${o}`):u.log(`\u4E0B\u8F7D\u6210\u529F: ${o}`)}}),u.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210")}async function N(n,e){u.info("\u5F00\u59CB\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:t,method:r,givenSftp:o}=e;await n.mkdir(t,r,o),u.info("\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210")}async function R(n,e){u.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55...");const t=`tem${new Date().getTime()}`;await C(n,`mkdir ${e}\\${t}`),await C(n,`robocopy ${e}\\${t} ${e} /mir`),await C(n,`rmdir ${e}\\${t}`),u.info("\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210")}export{R as clearRemoteWindowServerDir,S as execIntraServerCommand,v as execRemoteServerCommand,C as execRemoteWindowServerCommand,A as getBastionChannel,y as getBastionSSHClient,l as getDirectoryFromIntraServer,g as getDirectoryFromRemoteServer,k as getDirectoryFromRemoteWindowServer,F as getIntraServerSSHClient,m as getSSHClient,p as makeDirectoryOnIntraServer,b as makeDirectoryOnRemoteServer,N as makeDirectoryOnRemoteWindowServer,w as putDirectoryToIntraServer,$ as putDirectoryToRemoteServer,H as putDirectoryToRemoteWindowServer};
