import A from"path";import{NodeSSH as B}from"node-ssh";import m from"iconv-lite";import{logger as u}from"./logger.mjs";async function d(e){const{host:t,port:r,username:n,password:o,privateKey:E}=e,i=await new B().connect({host:t,port:Number(r),username:n,password:o,privateKey:E});return i.connection.on("error",c=>{c.code==="ECONNRESET"?u.info("SSH\u8FDE\u63A5\u88AB\u91CD\u7F6E"):u.error("SSH\u53D1\u751F\u5F02\u5E38:",c)}),i.connection.on("end",()=>{u.info("SSH\u8FDE\u63A5\u7ED3\u675F")}),i.connection.on("close",()=>{u.info("SSH\u8FDE\u63A5\u5173\u95ED")}),i}async function y(e){u.info("\u5F00\u59CB\u8FDE\u63A5\u5230\u8FDC\u7A0B\u5821\u5792\u673A...");const t=await d(e);return u.info("\u8FDE\u63A5\u5230\u8FDC\u7A0B\u5821\u5792\u673A\u6210\u529F"),t}async function D(e,t){const{srcIP:r="127.0.0.1",srcPort:n=0,dstIP:o,dstPort:E}=t;u.info("\u5F00\u59CB\u901A\u8FC7\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u96A7\u9053...");const i=await e.forwardOut(r,Number(n),o,Number(E));return u.info("\u901A\u8FC7\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u96A7\u9053\u6210\u529F"),i}async function C(e,t){const{username:r,password:n}=t,o=new B;return u.info("\u5F00\u59CB\u8FDE\u63A5\u5230\u5185\u90E8\u76EE\u6807\u670D\u52A1\u5668..."),await o.connect({sock:e,username:r,password:n}),u.info("\u8FDE\u63A5\u5230\u5185\u90E8\u76EE\u6807\u670D\u52A1\u5668\u6210\u529F"),o}async function S(e,t,r,n,o){const E=await D(e,t),i=await C(E,r);u.info(`\u6267\u884C\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u547D\u4EE4\u3010 ${n} \u3011`);const c=await i.execCommand(n),{stderr:a}=c,s=/\r?\n/,F=c.stdout.split(s);return u.info(`\u6267\u884C\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u547D\u4EE4\u3010 ${n} \u3011\u5B8C\u6210`),a&&u.error("\u6267\u884C\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u547D\u4EE4\u3010 ${command} \u3011\u53D1\u751F\u5F02\u5E38:",a),typeof o=="function"&&await o(F),i.dispose(),u.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),E.close(),u.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL"),c}async function w(e,t,r,n){const o=await D(e,t),E=await C(o,r);u.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668...");const{localDir:i,remoteDir:c}=n;await E.putDirectory(i,c,{recursive:!0,concurrency:10,validate:function(a){return A.basename(a).substr(0,1)!=="."},tick:function(a,s,F){F?u.error("\u4E0A\u4F20\u5230\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${a}`):u.log(`\u4E0A\u4F20\u5230\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u6210\u529F: \u672C\u5730\u6587\u4EF6${a}`)}}),u.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u5B8C\u6210"),E.dispose(),u.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),o.close(),u.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function l(e,t,r,n){const o=await D(e,t),E=await C(o,r);u.info("\u5F00\u59CB\u4ECE\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:i,remoteDir:c}=n;await E.getDirectory(i,c,{recursive:!0,concurrency:10,validate:function(a){return A.basename(a).substr(0,1)!=="."},tick:function(a,s,F){F?u.error("\u4ECE\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${s}`):u.log(`\u4ECE\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0B\u8F7D\u6210\u529F: \u8FDC\u7A0B\u6587\u4EF6${s}`)}}),u.info("\u4ECE\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210"),E.dispose(),u.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),o.close(),u.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function p(e,t,r,n){const o=await D(e,t),E=await C(o,r);u.info("\u5F00\u59CB\u5728\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:i,method:c,givenSftp:a}=n;await E.mkdir(i,c,a),u.info("\u5728\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210"),E.dispose(),u.info("dispose\u5821\u5792\u673A\u5185\u90E8\u670D\u52A1\u5668\u7684SSH"),o.close(),u.info("close\u5821\u5792\u673A\u4E0E\u5185\u90E8\u670D\u52A1\u5668\u5EFA\u7ACB\u7684CHANNEL")}async function v(e,t,r={},n){u.info(`\u6267\u884C\u547D\u4EE4\u3010 ${t} \u3011`);const o=await e.execCommand(t,{encoding:"utf8",...r}),{stderr:E}=o,i=/\r?\n/,c=o.stdout.split(i);u.info(`\u6267\u884C\u547D\u4EE4\u3010 ${t} \u3011\u5B8C\u6210`),E&&u.error(`\u6267\u884C\u547D\u4EE4 ${t} \u53D1\u751F\u5F02\u5E38`,E),typeof n=="function"&&await n(c)}async function $(e,t){u.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:r,remoteDir:n}=t;await e.putDirectory(r,n,{recursive:!0,concurrency:10,validate:function(o){return A.basename(o).substr(0,1)!=="."},tick:function(o,E,i){i?u.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${o}`):u.log(`\u4E0A\u4F20\u6210\u529F: \u672C\u5730\u6587\u4EF6${o}`)}}),u.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210")}async function g(e,t){u.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:r,remoteDir:n}=t;await e.getDirectory(r,n,{recursive:!0,concurrency:10,validate:function(o){return A.basename(o).substr(0,1)!=="."},tick:function(o,E,i){i?u.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${E}`):u.log(`\u4E0B\u8F7D\u6210\u529F: \u8FDC\u7A0B\u6587\u4EF6${E}`)}}),u.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210")}async function b(e,t){u.info("\u5F00\u59CB\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:r,method:n,givenSftp:o}=t;await e.mkdir(r,n,o),u.info("\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210")}async function f(e,t,r={},n){u.info(`\u6267\u884C\u547D\u4EE4\u3010 ${t} \u3011`);const o=await e.execCommand(t,{encoding:"binary",...r}),E=Buffer.isBuffer(o.stdout)?m.decode(o.stdout,"GBK"):o.stdout.toString(),i=Buffer.isBuffer(o.stderr)?m.decode(o.stderr,"GBK"):o.stderr.toString(),c=/\r?\n/,a=E.split(c);return u.info(`\u6267\u884C\u547D\u4EE4\u3010 ${t} \u3011\u5B8C\u6210`),i&&u.error(`\u6267\u884C\u547D\u4EE4 ${t} \u53D1\u751F\u5F02\u5E38`,i),typeof n=="function"&&await n(a),o}async function H(e,t){u.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668...");const{localDir:r,remoteDir:n}=t;await e.putDirectory(r,n,{recursive:!0,concurrency:10,validate:function(o){return A.basename(o).substr(0,1)!=="."},tick:function(o,E,i){i?u.error("\u4E0A\u4F20\u5931\u8D25:",`\u672C\u5730\u6587\u4EF6${o}`):u.log(`\u4E0A\u4F20\u6210\u529F: ${o}`)}}),u.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u5B8C\u6210")}async function k(e,t){u.info("\u5F00\u59CB\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730...");const{localDir:r,remoteDir:n}=t;await e.getDirectory(r,n,{recursive:!0,concurrency:10,validate:function(o){return A.basename(o).substr(0,1)!=="."},tick:function(o,E,i){i?u.error("\u4E0B\u8F7D\u5931\u8D25:",`\u8FDC\u7A0B\u6587\u4EF6${o}`):u.log(`\u4E0B\u8F7D\u6210\u529F: ${o}`)}}),u.info("\u4ECE\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0B\u8F7D\u76EE\u5F55\u5230\u672C\u5730\u5B8C\u6210")}async function N(e,t){u.info("\u5F00\u59CB\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55...");const{path:r,method:n,givenSftp:o}=t;await e.mkdir(r,n,o),u.info("\u5728\u8FDC\u7A0B\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u5F55\u5B8C\u6210")}async function R(e,t){u.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55...");const r=`tem${new Date().getTime()}`;await f(e,`mkdir ${t}${r}`),await f(e,`robocopy ${t}${r} ${t} /mir`),await f(e,`rmdir ${t}${r}`),u.info("\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210")}export{R as clearRemoteWindowServerDir,S as execIntraServerCommand,v as execRemoteServerCommand,f as execRemoteWindowServerCommand,D as getBastionChannel,y as getBastionSSHClient,l as getDirectoryFromIntraServer,g as getDirectoryFromRemoteServer,k as getDirectoryFromRemoteWindowServer,C as getIntraServerSSHClient,d as getSSHClient,p as makeDirectoryOnIntraServer,b as makeDirectoryOnRemoteServer,N as makeDirectoryOnRemoteWindowServer,w as putDirectoryToIntraServer,$ as putDirectoryToRemoteServer,H as putDirectoryToRemoteWindowServer};
