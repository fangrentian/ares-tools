"use strict";const u$1=require("fs"),f=require("dayjs"),utils_ssh=require("./ssh.cjs"),utils_childProcess=require("./childProcess.cjs"),utils_logger=require("./logger.cjs");function _interopDefaultCompat(e){return e&&typeof e=="object"&&"default"in e?e.default:e}const u__default=_interopDefaultCompat(u$1),f__default=_interopDefaultCompat(f),{PROJECT_DIR:w,LOCAL_DEPLOY_DIR:u,LOCAL_DOWNLOAD_DIR:y,TARGET_SSH_HOST:E,TARGET_SSH_USER:_,TARGET_SSH_PASSWORD:P,TARGET_SSH_PORT:H,TARGET_SSH_PRIVATE_KEY:g,TARGET_DIR:a,TARGET_FOLDER_TEMP:D,TARGET_FOLDER_TARGET:s}=process.env,i={host:E,port:H,username:_,password:P,privateKey:g,localDeployDir:u,localDownloadDir:y,remoteDirTemp:`${a}${D}`,remoteDirTarget:`${a}${s}`};async function buildProject(){utils_logger.logger.info("----->\u5F00\u59CB\u6253\u5305\u9879\u76EE...");const e=await utils_childProcess.execProjectPNPMCommand(w,"build:test");return utils_logger.logger.info("----->\u6253\u5305\u9879\u76EE\u5B8C\u6210"),e}async function backup(e){utils_logger.logger.info("----->\u5F00\u59CB\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE...");const r=f__default().format("YYYY-MM-DD_HHmmss");await utils_childProcess.execCommandUnderDirectory(i.localDownloadDir,`mkdir ${r}`);const o=await utils_ssh.getDirectoryFromRemoteWindowServer(e,{localDir:`${i.localDownloadDir}${r}`,remoteDir:i.remoteDirTarget});return utils_logger.logger.info("----->\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5B8C\u6210"),o}async function checkRemoteDirExist(e){return utils_logger.logger.info("----->\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u548C\u76EE\u6807\u76EE\u5F55..."),utils_ssh.execRemoteWindowServerCommand(e,`dir /ad /b /on ${a}`,{},async r=>{try{r.includes(D)||(utils_logger.logger.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u4E34\u65F6\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55..."),await utils_ssh.makeDirectoryOnRemoteWindowServer(e,{path:i.remoteDirTemp}),utils_logger.logger.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55\u6210\u529F")),r.includes(s)||(utils_logger.logger.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u76EE\u6807\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u76EE\u6807\u76EE\u5F55..."),await utils_ssh.makeDirectoryOnRemoteWindowServer(e,{path:i.remoteDirTarget}),utils_logger.logger.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u6807\u76EE\u5F55\u6210\u529F"))}catch(o){throw o}})}async function clearRemoteTempDir(e){utils_logger.logger.info("----->\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),await utils_ssh.clearRemoteWindowServerDir(e,i.remoteDirTemp),utils_logger.logger.info("----->\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210")}async function uploadToRemoteTempDir(e){utils_logger.logger.info("----->\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),await utils_ssh.putDirectoryToRemoteWindowServer(e,{localDir:i.localDeployDir,remoteDir:i.remoteDirTemp}),utils_logger.logger.info("----->\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210")}async function clearRemoteTargetDir(e){utils_logger.logger.info("----->\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55..."),await utils_ssh.clearRemoteWindowServerDir(e,i.remoteDirTarget),utils_logger.logger.info("----->\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210")}async function moveRemoteTempDirToTargetDir(e){utils_logger.logger.info("----->\u5F00\u59CB\u79FB\u52A8\u4E34\u65F6\u76EE\u5F55\u6587\u4EF6\u5230\u76EE\u6807\u76EE\u5F55..."),await utils_ssh.execRemoteWindowServerCommand(e,`robocopy ${i.remoteDirTemp} ${i.remoteDirTarget} /E /MOVE`),utils_logger.logger.info("----->\u6587\u4EF6\u79FB\u52A8\u5B8C\u6210")}async function deployWindowServer(e=!1){let r;try{if(!u__default.existsSync(i.localDeployDir))throw new Error(`\u672C\u5730\u76EE\u5F55 ${i.localDeployDir} \u4E0D\u5B58\u5728`);return e&&await buildProject(),r=await utils_ssh.getSSHClient(i),await checkRemoteDirExist(r),await clearRemoteTempDir(r),await uploadToRemoteTempDir(r),await clearRemoteTargetDir(r),await moveRemoteTempDirToTargetDir(r),utils_logger.logger.info("\u90E8\u7F72\u5B8C\u6210!"),!0}catch(o){return utils_logger.logger.error("\u90E8\u7F72\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF:",o),!1}finally{utils_logger.logger.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),r?.dispose()}}process.on("uncaughtException",e=>{utils_logger.logger.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u6355\u83B7\u7684\u5F02\u5E38: ${e}`)}),process.on("unhandledRejection",(e,r)=>{utils_logger.logger.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u5904\u7406\u7684\u62D2\u7EDD: ${r} \u539F\u56E0\u662F: ${e}`)}),exports.backup=backup,exports.buildProject=buildProject,exports.checkRemoteDirExist=checkRemoteDirExist,exports.clearRemoteTargetDir=clearRemoteTargetDir,exports.clearRemoteTempDir=clearRemoteTempDir,exports.deployWindowServer=deployWindowServer,exports.moveRemoteTempDirToTargetDir=moveRemoteTempDirToTargetDir,exports.uploadToRemoteTempDir=uploadToRemoteTempDir;
