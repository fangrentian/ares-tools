"use strict";const d=require("fs"),u=require("dayjs"),utils_logger=require("./logger.cjs"),utils_common=require("./common.cjs"),utils_ssh=require("./ssh.cjs"),utils_childProcess=require("./childProcess.cjs");function _interopDefaultCompat(e){return e&&typeof e=="object"&&"default"in e?e.default:e}const d__default=_interopDefaultCompat(d),u__default=_interopDefaultCompat(u);async function backup(e,r){const{localDownloadDir:o,remoteDir:i}=r;utils_logger.logger.info("\u5F00\u59CB\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE...");const t=u__default().format("YYYY-MM-DD_HHmmss");await utils_childProcess.execCommandUnderDirectory(o,`mkdir ${t}`);const E=await utils_ssh.getDirectoryFromRemoteWindowServer(e,{localDir:`${o}${t}`,remoteDir:i});return utils_logger.logger.info("\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5B8C\u6210"),E}async function checkRemoteDirExist(e,r){const{remoteDir:o,remoteDirTemp:i}=r;if(utils_logger.logger.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55..."),(await utils_ssh.execRemoteWindowServerCommand(e,`dir /ad /b /on ${o}`)).code!==0)try{utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u76EE\u6807\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u76EE\u6807\u76EE\u5F55..."),await utils_ssh.makeDirectoryOnRemoteWindowServer(e,{path:o}),utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u6807\u76EE\u5F55\u6210\u529F")}catch(t){throw t}if(utils_logger.logger.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),(await utils_ssh.execRemoteWindowServerCommand(e,`dir /ad /b /on ${i}`)).code!==0)try{utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u4E34\u65F6\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55..."),await utils_ssh.makeDirectoryOnRemoteWindowServer(e,{path:i}),utils_logger.logger.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55\u6210\u529F")}catch(t){throw t}}async function clearRemoteTempDir(e,r){const{remoteDirTemp:o}=r;utils_logger.logger.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),await utils_ssh.clearRemoteWindowServerDir(e,o),utils_logger.logger.info("\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210")}async function uploadToRemoteTempDir(e,r){const{localDeployDir:o,remoteDirTemp:i}=r;utils_logger.logger.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),await utils_ssh.putDirectoryToRemoteWindowServer(e,{localDir:o,remoteDir:i}),utils_logger.logger.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210")}async function clearRemoteTargetDir(e,r){const{remoteDir:o}=r;utils_logger.logger.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55..."),await utils_ssh.clearRemoteWindowServerDir(e,o),utils_logger.logger.info("\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210")}async function moveRemoteTempDirToTargetDir(e,r){const{remoteDir:o,remoteDirTemp:i}=r;utils_logger.logger.info("\u5F00\u59CB\u79FB\u52A8\u4E34\u65F6\u76EE\u5F55\u6587\u4EF6\u5230\u76EE\u6807\u76EE\u5F55..."),await utils_ssh.execRemoteWindowServerCommand(e,`robocopy ${i} ${o} /E /MOVE`),utils_logger.logger.info("\u6587\u4EF6\u79FB\u52A8\u5B8C\u6210")}async function deployToWindowsServer(e={},r={}){let o;const i=utils_common.getBuildConfig(e),t=utils_common.getWindowsServerTargetConfig(r);try{if(!d__default.existsSync(t.localDeployDir))throw new Error(`\u672C\u5730\u76EE\u5F55 ${t.localDeployDir} \u4E0D\u5B58\u5728`);return i.build&&await utils_common.buildProject(i),o=await utils_ssh.getSSHClient(t),await checkRemoteDirExist(o,t),await clearRemoteTempDir(o,t),await uploadToRemoteTempDir(o,t),await clearRemoteTargetDir(o,t),await moveRemoteTempDirToTargetDir(o,t),utils_logger.logger.info("\u90E8\u7F72\u5B8C\u6210!"),!0}catch(E){return utils_logger.logger.error("\u90E8\u7F72\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF:",E),!1}finally{utils_logger.logger.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),o?.dispose()}}process.on("uncaughtException",e=>{utils_logger.logger.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u6355\u83B7\u7684\u5F02\u5E38: ${e}`)}),process.on("unhandledRejection",(e,r)=>{utils_logger.logger.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u5904\u7406\u7684\u62D2\u7EDD: ${r} \u539F\u56E0\u662F: ${e}`)}),exports.backup=backup,exports.checkRemoteDirExist=checkRemoteDirExist,exports.clearRemoteTargetDir=clearRemoteTargetDir,exports.clearRemoteTempDir=clearRemoteTempDir,exports.deployToWindowsServer=deployToWindowsServer,exports.moveRemoteTempDirToTargetDir=moveRemoteTempDirToTargetDir,exports.uploadToRemoteTempDir=uploadToRemoteTempDir;
