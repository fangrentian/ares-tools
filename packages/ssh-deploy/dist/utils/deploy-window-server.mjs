import f from"fs";import s from"dayjs";import{getDirectoryFromRemoteWindowServer as B,execRemoteWindowServerCommand as i,clearRemoteWindowServerDir as a,getSSHClient as p,putDirectoryToRemoteWindowServer as R,makeDirectoryOnRemoteWindowServer as n}from"./ssh.mjs";import{execCommandUnderDirectory as w,execProjectPNPMCommand as S}from"./childProcess.mjs";import{logger as u}from"./logger.mjs";const{PROJECT_DIR:d,LOCAL_DEPLOY_DIR:y,LOCAL_DOWNLOAD_DIR:_,TARGET_SSH_HOST:$,TARGET_SSH_USER:g,TARGET_SSH_PASSWORD:O,TARGET_SSH_PORT:H,TARGET_SSH_PRIVATE_KEY:P,TARGET_DIR:t,TARGET_FOLDER_TEMP:D,TARGET_FOLDER_TARGET:F}=process.env,o={host:$,port:H,username:g,password:O,privateKey:P,localDeployDir:y,localDownloadDir:_,remoteDirTemp:`${t}${D}`,remoteDirTarget:`${t}${F}`};async function c(){u.info("----->\u5F00\u59CB\u6253\u5305\u9879\u76EE...");const E=await S(d,"build:test");return u.info("----->\u6253\u5305\u9879\u76EE\u5B8C\u6210"),E}async function h(E){u.info("----->\u5F00\u59CB\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE...");const e=s().format("YYYY-MM-DD_HHmmss");await w(o.localDownloadDir,`mkdir ${e}`);const r=await B(E,{localDir:`${o.localDownloadDir}${e}`,remoteDir:o.remoteDirTarget});return u.info("----->\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5B8C\u6210"),r}async function A(E){return u.info("----->\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u548C\u76EE\u6807\u76EE\u5F55..."),i(E,`dir /ad /b /on ${t}`,{},async e=>{try{e.includes(D)||(u.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u4E34\u65F6\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55..."),await n(E,{path:o.remoteDirTemp}),u.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55\u6210\u529F")),e.includes(F)||(u.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u76EE\u6807\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u76EE\u6807\u76EE\u5F55..."),await n(E,{path:o.remoteDirTarget}),u.info("----->\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u6807\u76EE\u5F55\u6210\u529F"))}catch(r){throw r}})}async function m(E){u.info("----->\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),await a(E,o.remoteDirTemp),u.info("----->\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210")}async function l(E){u.info("----->\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),await R(E,{localDir:o.localDeployDir,remoteDir:o.remoteDirTemp}),u.info("----->\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210")}async function T(E){u.info("----->\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55..."),await a(E,o.remoteDirTarget),u.info("----->\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210")}async function C(E){u.info("----->\u5F00\u59CB\u79FB\u52A8\u4E34\u65F6\u76EE\u5F55\u6587\u4EF6\u5230\u76EE\u6807\u76EE\u5F55..."),await i(E,`robocopy ${o.remoteDirTemp} ${o.remoteDirTarget} /E /MOVE`),u.info("----->\u6587\u4EF6\u79FB\u52A8\u5B8C\u6210")}async function v(E=!1){let e;try{if(!f.existsSync(o.localDeployDir))throw new Error(`\u672C\u5730\u76EE\u5F55 ${o.localDeployDir} \u4E0D\u5B58\u5728`);return E&&await c(),e=await p(o),await A(e),await m(e),await l(e),await T(e),await C(e),u.info("\u90E8\u7F72\u5B8C\u6210!"),!0}catch(r){return u.error("\u90E8\u7F72\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF:",r),!1}finally{u.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),e?.dispose()}}process.on("uncaughtException",E=>{u.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u6355\u83B7\u7684\u5F02\u5E38: ${E}`)}),process.on("unhandledRejection",(E,e)=>{u.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u5904\u7406\u7684\u62D2\u7EDD: ${e} \u539F\u56E0\u662F: ${E}`)});export{h as backup,c as buildProject,A as checkRemoteDirExist,T as clearRemoteTargetDir,m as clearRemoteTempDir,v as deployWindowServer,C as moveRemoteTempDirToTargetDir,l as uploadToRemoteTempDir};
