import C from"fs";import B from"dayjs";import{logger as o}from"./logger.mjs";import{getBuildConfig as l,getWindowsServerTargetConfig as s,buildProject as w}from"./common.mjs";import{getSSHClient as p,getDirectoryFromRemoteWindowServer as d,execRemoteWindowServerCommand as n,makeDirectoryOnRemoteWindowServer as a,clearRemoteWindowServerDir as F,putDirectoryToRemoteWindowServer as y}from"./ssh.mjs";import{execCommandUnderDirectory as S}from"./childProcess.mjs";async function T(e,E){const{localDownloadDir:u,remoteDir:i}=E;o.info("\u5F00\u59CB\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE...");const r=B().format("YYYY-MM-DD_HHmmss");await S(u,`mkdir ${r}`);const t=await d(e,{localDir:`${u}${r}`,remoteDir:i});return o.info("\u5907\u4EFD\u8FDC\u7A0B\u9879\u76EE\u5B8C\u6210"),t}async function D(e,E){const{remoteDir:u,remoteDirTemp:i}=E;if(o.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55..."),(await n(e,`dir /ad /b /on ${u}`)).code!==0)try{o.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u76EE\u6807\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u76EE\u6807\u76EE\u5F55..."),await a(e,{path:u}),o.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u76EE\u6807\u76EE\u5F55\u6210\u529F")}catch(r){throw r}if(o.info("\u5F00\u59CB\u68C0\u67E5\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),(await n(e,`dir /ad /b /on ${i}`)).code!==0)try{o.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u6CA1\u6709\u4E34\u65F6\u76EE\u5F55, \u5F00\u59CB\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55..."),await a(e,{path:i}),o.info("\u76EE\u6807\u670D\u52A1\u5668\u4E0A\u521B\u5EFA\u4E34\u65F6\u76EE\u5F55\u6210\u529F")}catch(r){throw r}}async function c(e,E){const{remoteDirTemp:u}=E;o.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),await F(e,u),o.info("\u6E05\u7A7A\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210")}async function m(e,E){const{localDeployDir:u,remoteDirTemp:i}=E;o.info("\u5F00\u59CB\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55..."),await y(e,{localDir:u,remoteDir:i}),o.info("\u4E0A\u4F20\u672C\u5730\u76EE\u5F55\u5230\u8FDC\u7A0B\u670D\u52A1\u5668\u4E34\u65F6\u76EE\u5F55\u5B8C\u6210")}async function A(e,E){const{remoteDir:u}=E;o.info("\u5F00\u59CB\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55..."),await F(e,u),o.info("\u6E05\u7A7A\u670D\u52A1\u5668\u76EE\u6807\u76EE\u5F55\u5B8C\u6210")}async function f(e,E){const{remoteDir:u,remoteDirTemp:i}=E;o.info("\u5F00\u59CB\u79FB\u52A8\u4E34\u65F6\u76EE\u5F55\u6587\u4EF6\u5230\u76EE\u6807\u76EE\u5F55..."),await n(e,`robocopy ${i} ${u} /E /MOVE`),o.info("\u6587\u4EF6\u79FB\u52A8\u5B8C\u6210")}async function g(e={},E={}){let u;const i=l(e),r=s(E);try{if(!C.existsSync(r.localDeployDir))throw new Error(`\u672C\u5730\u76EE\u5F55 ${r.localDeployDir} \u4E0D\u5B58\u5728`);return i.build&&await w(i),u=await p(r),await D(u,r),await c(u,r),await m(u,r),await A(u,r),await f(u,r),o.info("\u90E8\u7F72\u5B8C\u6210!"),!0}catch(t){return o.error("\u90E8\u7F72\u8FC7\u7A0B\u4E2D\u51FA\u73B0\u9519\u8BEF:",t),!1}finally{o.info("\u9500\u6BC1bastionSSH\u548CtargetSSH\u8FDE\u63A5"),u?.dispose()}}process.on("uncaughtException",e=>{o.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u6355\u83B7\u7684\u5F02\u5E38: ${e}`)}),process.on("unhandledRejection",(e,E)=>{o.error(`\u7CFB\u7EDF\u53D1\u751F\u672A\u5904\u7406\u7684\u62D2\u7EDD: ${E} \u539F\u56E0\u662F: ${e}`)});export{T as backup,D as checkRemoteDirExist,A as clearRemoteTargetDir,c as clearRemoteTempDir,g as deployToWindowsServer,f as moveRemoteTempDirToTargetDir,m as uploadToRemoteTempDir};
