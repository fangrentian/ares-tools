"use strict";const T=require("axios"),autobindDecorator=require("autobind-decorator"),constant=require("./config/constant.cjs");function _interopDefaultCompat(o){return o&&typeof o=="object"&&"default"in o?o.default:o}const T__default=_interopDefaultCompat(T);var S=(o,d,i,f)=>{for(var c=d,l=o.length-1,g;l>=0;l--)(g=o[l])&&(c=g(c)||c);return c};function isPlainObject(o){if(typeof o!="object"||o===null||Object.prototype.toString.call(o)!=="[object Object]")return!1;const d=Object.getPrototypeOf(o);if(d===null)return!0;const i=Object.prototype.hasOwnProperty.call(d,"constructor")&&d.constructor;return i&&typeof i=="function"&&i===Object}function parsePath(o){if(!o||typeof o!="string")return{root:"",dir:"",base:"",ext:"",name:""};const d=o.replace(/\\/g,"/").split("/"),i=d.pop()||"";let f="";const c=i.lastIndexOf(".");c>0&&(f=i.slice(c));const l=c>0?i.slice(0,c):i;return{root:o.startsWith("/")?"/":"",dir:d.join("/"),base:i,ext:f,name:l}}const defineAxiosService=(o={})=>{const d=`${location.protocol}//${location.hostname}:${location.port}`,i={baseUrl:d,host:d,responseSuccessStatus:constant.RESPONSE_SUCCESS_STATUS,responseSuccessCode:constant.RESPONSE_SUCCESS_CODE,responseCodeField:constant.RESPONSE_CODE_FIELD,responseMsgField:constant.RESPONSE_MSG_FIELD,pageQueryPageField:constant.PAGE_QUERY_PAGE_FIELD,pageQueryPageSizeField:constant.PAGE_QUERY_PAGE_SIZE_FIELD,pageQueryPageBoField:constant.PAGE_QUERY_PAGE_BO_FIELD,sessionExpireCode:constant.SESSION_EXPIRE_CODE,requestContentType:constant.REQUEST_CONTENT_TYPE,requestTimeout:constant.REQUEST_TIMEOUT,tokenKey:constant.TOKEN_KEY,...o},f=T__default.create({baseURL:i.baseUrl,timeout:i.requestTimeout,withCredentials:!0,data:{},params:{},headers:{"Content-Type":i.requestContentType}}),c=T__default.create({baseURL:i.baseUrl,withCredentials:!0,data:{},params:{},headers:{"Content-Type":"multipart/form-data"}}),l=T__default.create({baseURL:i.baseUrl,withCredentials:!0,params:{},responseType:"blob"}),g=e=>(e.params._t=+new Date,e.headers[i.tokenKey]=typeof i.getToken=="function"?i.getToken():localStorage.getItem(i.tokenKey),e),m=e=>Promise.reject(e),C=e=>{const{data:t,status:r}=e,s=t[i.responseCodeField],a=t[i.responseMsgField];return r!=i.responseSuccessStatus?Promise.reject({code:s,msg:a}):s==i.responseSuccessCode?Promise.resolve(t):Promise.reject({code:s,msg:a})},x=e=>{const{code:t,config:r}=e;let s={code:i.responseSuccessCode,msg:t||"request canceled",data:null};const a=r?.signal;if(r&&a&&a?.aborted)return a.reason?.code&&(s.code=a.reason.code),a.reason?.msg&&(s.msg=a.reason.msg),Promise.resolve(s);const n=e.response;if(!n)return Promise.reject({code:e.code,msg:e.message});const u=n?.data?.status||n?.status||0,p=n?.data?.error||n?.statusText||"";return Promise.reject({code:u,msg:p})};f.interceptors.request.use(g,m),f.interceptors.response.use(C,x),c.interceptors.request.use(g,m),c.interceptors.response.use(C,x),l.interceptors.request.use(g,m);const $=(e,t)=>{let{code:r,msg:s}=e;console.error("##\u63A5\u53E3\u51FA\u9519",e),!t&&(s||(s="unknown error"),typeof i.handleErrorMsg=="function"&&i.handleErrorMsg(s),r==i.sessionExpireCode&&setTimeout(()=>{window.location.replace(i.host)},2e3))};async function P(e,t,r){return await e(t).then(function(s){return Promise.resolve(s)}).catch(function(s){return $(s,r),Promise.reject(s)})}async function b(e,t=!1){return await P(f,e,t)}async function v(e,t=!1){return await P(c,e,t)}async function O(e,t=!1){return await P(l,e,t)}async function q(e){return await T__default.create()(e)}let y=class{requester;definedServiceEnv;module;prefix;permissionPrefix;permissionConfig;apiPathConfig;constructor(e={},t){const{module:r="sys",prefix:s="/",permissionPrefix:a,permissionConfig:n={},apiPathConfig:u={}}=e;this.module=r,this.prefix=s,this.permissionPrefix=a?`${a}:`:`sys:${r}:`,this.permissionConfig={create:`${this.permissionPrefix}create`,remove:`${this.permissionPrefix}remove`,removeBatch:`${this.permissionPrefix}removeBatch`,update:`${this.permissionPrefix}update`,updateBatch:`${this.permissionPrefix}updateBatch`,createOrUpdate:`${this.permissionPrefix}createOrUpdate`,detail:`${this.permissionPrefix}getDetail`,list:`${this.permissionPrefix}list`,pageList:`${this.permissionPrefix}pageList`},Object.keys(n).forEach(p=>{this.permissionConfig[p]=`${this.permissionPrefix}${n[p]}`}),this.apiPathConfig={create:`${this.prefix}create`,remove:`${this.prefix}remove`,removeBatch:`${this.prefix}removeBatch`,update:`${this.prefix}update`,updateBatch:`${this.prefix}updateBatch`,createOrUpdate:`${this.prefix}createOrUpdate`,detail:`${this.prefix}getDetail`,list:`${this.prefix}list`,pageList:`${this.prefix}pageList`},Object.keys(u).forEach(p=>{this.apiPathConfig[p]=`${this.prefix}${u[p]}`}),this.requester=t||b,this.definedServiceEnv={...i}}async create(e,t=!1){const r={url:this.apiPathConfig.create,method:"post",data:e};return this.requester(r,t)}async remove(e,t="id",r=!1){const s={};s[t]=e;const a={url:this.apiPathConfig.remove,method:"delete",data:s};return this.requester(a,r)}async removeBatch(e,t,r=!1){const s=t?{[t]:e}:e,a={url:this.apiPathConfig.removeBatch,method:"delete",data:s};return this.requester(a,r)}async postRemove(e,t="id",r=!1){const s={};s[t]=e;const a={url:this.apiPathConfig.remove,method:"post",data:s};return this.requester(a,r)}async postRemoveBatch(e,t,r=!1){const s=t?{[t]:e}:e,a={url:this.apiPathConfig.removeBatch,method:"post",data:s};return this.requester(a,r)}async update(e,t=!1){const r={url:this.apiPathConfig.update,method:"put",data:e};return this.requester(r,t)}async createOrUpdate(e,t=!1){const r={url:this.apiPathConfig.createOrUpdate,method:"post",data:e};return this.requester(r,t)}async postUpdate(e,t=!1){const r={url:this.apiPathConfig.update,method:"post",data:e};return this.requester(r,t)}async getDetail(e,t="id",r=!1){const s={};s[t]=e;const a={url:this.apiPathConfig.detail,method:"get",data:s};return this.requester(a,r)}async getDetailByPageList(e,t="id",r=!1){return this.postPageList(1,1,{[t]:e},r).then(s=>{const a=s.data?.list;return a.length>0?a[0]:{}})}async getDetailByPageListV1(e,t="id",r=!1){return this.postPageListV1({pageIndex:1,pageSize:10,[t]:e},r).then(s=>{const a=s.data?.list;return a.length>0?a[0]:{}})}async getList(e=[],t=!1){const r={};e.forEach(({fieldName:a,fieldValue:n})=>{r[a]=n});const s={url:this.apiPathConfig.list,method:"get",params:r};return this.requester(s,t)}async postList(e=[],t=!1){const r={};e.forEach(({fieldName:a,fieldValue:n})=>{r[a]=n});const s={url:this.apiPathConfig.list,method:"post",data:r};return this.requester(s,t)}async getPageList(e=1,t=10,r={},s=!1){const a={[i.pageQueryPageField]:e,[i.pageQueryPageSizeField]:t,...r},n={url:this.apiPathConfig.pageList,method:"get",params:a};return this.requester(n,s)}async postPageList(e=1,t=10,r={},s=!1){const a={[i.pageQueryPageBoField]:{[i.pageQueryPageField]:e,[i.pageQueryPageSizeField]:t},...r},n={url:this.apiPathConfig.pageList,method:"post",data:a};return this.requester(n,s)}async postPageListV1(e={pageIndex:1,pageSize:10},t=!1){let r={...e};delete r.pageIndex,delete r.pageSize;const s={[i.pageQueryPageBoField]:{[i.pageQueryPageField]:e.pageIndex,[i.pageQueryPageSizeField]:e.pageSize},...r},a={url:this.apiPathConfig.pageList,method:"post",data:s};return this.requester(a,t)}async upload(e,t,r,s,a,n=!1){s=isPlainObject(s)?s:{},a=isPlainObject(a)?a:{};const u=new FormData;u.append(r,t),Object.keys(s).length&&Object.keys(s).forEach(h=>{u.append(h,s[h])});const p={...a,params:s,method:"post",data:u,url:e};return v(p,n)}async download(e,t,r,s,a=!1){t=isPlainObject(t)?t:{},r=isPlainObject(r)?r:{},s=isPlainObject(s)?s:{};const n={...s,params:r,url:e};return O(n,a).then(u=>{const p=new Blob([u.data]),h=document.createElement("a"),E=window.URL.createObjectURL(p),_=r.path?parsePath(r.path).base:null,L=_||`${t.filename==null?"":t.filename}${+new Date}.${t.suffix}`;return h.href=E,h.download=L||"download",document.body.appendChild(h),h.click(),document.body.removeChild(h),window.URL.revokeObjectURL(E),{blob:p,href:E}}).catch(function(u){console.error("\u4E0B\u8F7D\u5F02\u5E38",u)})}async getService(e,t=!1){return this.requester({...e,method:"get"},t)}async postService(e,t=!1){return this.requester({...e,method:"post"},t)}async deleteService(e,t=!1){return this.requester({...e,method:"delete"},t)}async putService(e,t=!1){return this.requester({...e,method:"put"},t)}};return y=S([autobindDecorator.boundClass],y),{$service:b,$upload:v,$download:O,$axios:q,BaseService:y}};exports.defineAxiosService=defineAxiosService,exports.isPlainObject=isPlainObject,exports.parsePath=parsePath;
