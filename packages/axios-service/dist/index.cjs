"use strict";const x=require("axios"),autobindDecorator=require("autobind-decorator"),pathBrowserify=require("path-browserify"),lodashEs=require("lodash-es"),constant=require("./config/constant.cjs");function _interopDefaultCompat(c){return c&&typeof c=="object"&&"default"in c?c.default:c}const x__default=_interopDefaultCompat(x);var j=(c,f,d,g)=>{for(var p=f,h=c.length-1,l;h>=0;h--)(l=c[h])&&(p=l(p)||p);return p};const defineAxiosService=(c={})=>{const f=`${location.protocol}//${location.hostname}:${location.port}`,d={baseUrl:f,host:f,responseSuccessStatus:constant.RESPONSE_SUCCESS_STATUS,responseSuccessCode:constant.RESPONSE_SUCCESS_CODE,responseCodeField:constant.RESPONSE_CODE_FIELD,responseMsgField:constant.RESPONSE_MSG_FIELD,sessionExpireCode:constant.SESSION_EXPIRE_CODE,defaultHeaders:constant.REQUEST_CONTENT_TYPE,requestTimeout:constant.REQUEST_TIMEOUT,tokenKey:constant.TOKEN_KEY,...c},{baseUrl:g,host:p,responseSuccessStatus:h,responseSuccessCode:l,sessionExpireCode:D,requestTimeout:R,tokenKey:q,getToken:b,handleErrorMsg:O}=d,m=x__default.create({baseURL:g,timeout:R,withCredentials:!0,data:{},params:{},headers:{"Content-Type":"application/json; charset=utf-8"}}),P=x__default.create({baseURL:g,withCredentials:!0,data:{},params:{},headers:{"Content-Type":"multipart/form-data"}}),w=x__default.create({baseURL:g,withCredentials:!0,params:{},responseType:"blob"}),C=e=>(e.params._t=+new Date,e.headers[q]=typeof b=="function"?b():localStorage.getItem(q),e),y=e=>Promise.reject(e),L=e=>{const{data:t,status:s}=e,r=t[d.responseCodeField],a=t[d.responseMsgField];return s!=h?Promise.reject({code:r,msg:a}):r==l?Promise.resolve(t):Promise.reject({code:r,msg:a})},U=e=>{const{code:t,config:s}=e;let r={code:l,msg:t||"request canceled",data:null};const a=s?.signal;if(s&&a&&a?.aborted)return a.reason?.code&&(r.code=a.reason.code),a.reason?.msg&&(r.msg=a.reason.msg),Promise.resolve(r);const i=e.response;if(!i)return Promise.reject({code:e.code,msg:e.message});const o=i?.data?.status||i?.status||0,n=i?.data?.error||i?.statusText||"";return Promise.reject({code:o,msg:n})};m.interceptors.request.use(C,y),m.interceptors.response.use(L,U),P.interceptors.request.use(C,y),P.interceptors.response.use(L,U),w.interceptors.request.use(C,y);const k=(e,t)=>{let{code:s,msg:r}=e;console.error("##\u63A5\u53E3\u51FA\u9519",e),!t&&(r||(r="unknown error"),typeof O=="function"&&O(r),s==D&&setTimeout(()=>{window.location.replace(p)},2e3))};async function S(e,t,s){return await e(t).then(function(r){return Promise.resolve(r)}).catch(function(r){return k(r,s),Promise.reject(r)})}async function B(e,t=!1){return await S(m,e,t)}async function T(e,t=!1){return await S(P,e,t)}async function _(e,t=!1){return await S(w,e,t)}async function F(e){return await x__default.create()(e)}class E{module;prefix;permissionPrefix;permissionConfig;apiPathConfig;constructor(t){const{module:s="sys",prefix:r="/",permissionPrefix:a,permissionConfig:i={},apiPathConfig:o={}}=t;this.module=s,this.prefix=r,this.permissionPrefix=a?`${a}:`:`sys:${s}:`,this.permissionConfig={create:`${this.permissionPrefix}create`,remove:`${this.permissionPrefix}remove`,removeBatch:`${this.permissionPrefix}removeBatch`,update:`${this.permissionPrefix}update`,updateBatch:`${this.permissionPrefix}updateBatch`,createOrUpdate:`${this.permissionPrefix}createOrUpdate`,detail:`${this.permissionPrefix}getDetail`,list:`${this.permissionPrefix}list`,pageList:`${this.permissionPrefix}pageList`},Object.keys(i).forEach(n=>{this.permissionConfig[n]=`${this.permissionPrefix}${i[n]}`}),this.apiPathConfig={create:`${this.prefix}create`,remove:`${this.prefix}remove`,removeBatch:`${this.prefix}removeBatch`,update:`${this.prefix}update`,updateBatch:`${this.prefix}updateBatch`,createOrUpdate:`${this.prefix}createOrUpdate`,detail:`${this.prefix}getDetail`,list:`${this.prefix}list`,pageList:`${this.prefix}pageList`},Object.keys(o).forEach(n=>{this.apiPathConfig[n]=`${this.prefix}${o[n]}`})}}let $=class{requester;config;definedConfig;constructor(e={},t,s=E){s=s||E,this.requester=t||B,this.config=new s(e),this.definedConfig={...d}}async create(e,t=!1){const s={url:this.config.apiPathConfig.create,method:"post",data:e};return this.requester(s,t)}async remove(e,t="id",s=!1){const r={};r[t]=e;const a={url:this.config.apiPathConfig.remove,method:"delete",data:r};return this.requester(a,s)}async removeBatch(e,t,s=!1){const r=t?{[t]:e}:e,a={url:this.config.apiPathConfig.removeBatch,method:"delete",data:r};return this.requester(a,s)}async postRemove(e,t="id",s=!1){const r={};r[t]=e;const a={url:this.config.apiPathConfig.remove,method:"post",data:r};return this.requester(a,s)}async postRemoveBatch(e,t,s=!1){const r=t?{[t]:e}:e,a={url:this.config.apiPathConfig.removeBatch,method:"post",data:r};return this.requester(a,s)}async update(e,t=!1){const s={url:this.config.apiPathConfig.update,method:"put",data:e};return this.requester(s,t)}async createOrUpdate(e,t=!1){const s={url:this.config.apiPathConfig.createOrUpdate,method:"post",data:e};return this.requester(s,t)}async postUpdate(e,t=!1){const s={url:this.config.apiPathConfig.update,method:"post",data:e};return this.requester(s,t)}async getDetail(e,t="id",s=!1){const r={};r[t]=e;const a={url:this.config.apiPathConfig.detail,method:"get",data:r};return this.requester(a,s)}async getDetailByPageList(e,t="id",s=!1){return this.postPageList(1,1,{[t]:e},s).then(r=>{const a=r.data?.list;return a.length>0?a[0]:{}})}async getDetailByPageListV1(e,t="id",s=!1){return this.postPageListV1({pageIndex:1,pageSize:10,[t]:e},s).then(r=>{const a=r.data?.list;return a.length>0?a[0]:{}})}async getList(e=[],t=!1){const s={};e.forEach(({fieldName:a,fieldValue:i})=>{s[a]=i});const r={url:this.config.apiPathConfig.list,method:"get",params:s};return this.requester(r,t)}async postList(e=[],t=!1){const s={};e.forEach(({fieldName:a,fieldValue:i})=>{s[a]=i});const r={url:this.config.apiPathConfig.list,method:"post",data:s};return this.requester(r,t)}async getPageList(e=1,t=10,s={},r=!1){const a={page:e,pageSize:t,...s},i={url:this.config.apiPathConfig.pageList,method:"get",params:a};return this.requester(i,r)}async postPageList(e=1,t=10,s={},r=!1){const a={pageBo:{page:e,pageSize:t},...s},i={url:this.config.apiPathConfig.pageList,method:"post",data:a};return this.requester(i,r)}async postPageListV1(e={pageIndex:1,pageSize:10},t=!1){let s={...e};delete s.pageIndex,delete s.pageSize;const r={pageBo:{page:e.pageIndex,pageSize:e.pageSize},...s},a={url:this.config.apiPathConfig.pageList,method:"post",data:r};return this.requester(a,t)}async upload(e,t,s,r,a,i=!1){r=lodashEs.isPlainObject(r)?r:{},a=lodashEs.isPlainObject(a)?a:{};const o=new FormData;o.append(s,t),Object.keys(r).length&&Object.keys(r).forEach(u=>{o.append(u,r[u])});const n={...a,params:r,method:"post",data:o,url:e};return T(n,i)}async download(e,t,s,r,a=!1){t=lodashEs.isPlainObject(t)?t:{},s=lodashEs.isPlainObject(s)?s:{},r=lodashEs.isPlainObject(r)?r:{};const i={...r,params:s,url:e};return _(i,a).then(o=>{const n=new Blob([o.data]),u=document.createElement("a"),v=window.URL.createObjectURL(n),I=s.path?pathBrowserify.parse(s.path).base:null,N=I||`${t.filename==null?"":t.filename}${+new Date}.${t.suffix}`;return u.href=v,u.download=N||"download",document.body.appendChild(u),u.click(),document.body.removeChild(u),window.URL.revokeObjectURL(v),{blob:n,href:v}}).catch(function(o){console.error("\u4E0B\u8F7D\u5F02\u5E38",o)})}async getService(e,t=!1){return this.requester({...e,method:"get"},t)}async postService(e,t=!1){return this.requester({...e,method:"post"},t)}async deleteService(e,t=!1){return this.requester({...e,method:"delete"},t)}async putService(e,t=!1){return this.requester({...e,method:"put"},t)}};return $=j([autobindDecorator.boundClass],$),{$service:B,$upload:T,$download:_,$axios:F,BaseServiceConfigurator:E,BaseService:$}};exports.defineAxiosService=defineAxiosService;
